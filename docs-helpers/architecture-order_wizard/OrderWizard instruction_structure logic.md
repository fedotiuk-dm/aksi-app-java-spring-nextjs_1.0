# Односторінкова система замовлень хімчистки

## Огляд та архітектура

Односторінкова система замовлень хімчистки — це компактний інтерфейс для швидкого оформлення замовлень з інтегрованою системою розрахунку цін, управлінням клієнтами та формуванням квитанцій. Вся функціональність розміщена на одній сторінці для максимальної ефективності операторів.

## Структура односторінкової системи (3 основні секції)

### Секція 1: Клієнт та базова інформація замовлення (лівий блок - 30%)

#### 1.1. Швидкий пошук та управління клієнтами

- **Пошук існуючого клієнта**
  - Автозаповнення за прізвищем, ім'ям, телефоном, email
  - Швидкий вибір клієнта зі списку результатів
  - Можливість редагування обраного клієнта

#### 1.2. Міні-форма нового клієнта (згортається/розгортається)

- **Обов'язкові поля**:
  - Прізвище та ім'я
  - Телефон
- **Опційні поля**:
  - Email
  - Адреса
- **Способи зв'язку** (мультивибір чекбоксів):
  - Номер телефону
  - SMS
  - Viber
- **Джерело інформації про хімчистку** (дропдаун):
  - Інстаграм
  - Google
  - Рекомендації
  - Інше (з полем для уточнення)

#### 1.3. Базова інформація замовлення

- **Номер квитанції** (генерується автоматично)
- **Унікальна мітка** (поле вводу + сканер QR-коду)
- **Пункт прийому замовлення** (дропдаун вибору філії)
- **Дата створення замовлення** (відображається автоматично)

### Секція 2: Предмети та розрахунки (центральний блок - 50%)

#### 2.1. Компактна таблиця предметів

- **Заголовки таблиці**: Найменування | Категорія | К-сть | Матеріал | Колір | Сума | Дії
- **Функціональність**:
  - Кнопка "+" для додавання нових рядків
  - Інлайн-редагування існуючих рядків
  - Кнопки "Редагувати" та "Видалити" для кожного рядка

#### 2.2. Швидка форма додавання предмета (розгортається під таблицею)

##### Основна інформація про предмет

- **Категорія послуги** (дропдаун, автооновлює список предметів):

  - Чистка одягу та текстилю
  - Прання білизни
  - Прасування
  - Чистка та відновлення шкіряних виробів
  - Дублянки
  - Вироби із натурального хутра
  - Фарбування текстильних виробів

- **Найменування виробу** (динамічний список на основі категорії)
- **Одиниця виміру і кількість**:
  - Штуки (для більшості виробів)
  - Кілограми (для білизни та певних текстильних виробів)
  - Поле для введення числового значення

##### Характеристики предмета

- **Матеріал** (дропдаун, залежить від категорії):

  - Бавовна, Шерсть, Шовк, Синтетика
  - Гладка шкіра, Нубук, Спілок, Замша

- **Колір**:

  - Список базових кольорів для швидкого вибору
  - Поле для введення власного кольору

- **Наповнювач** (для відповідних категорій):

  - Пух, Синтепон, Інше (вручну)
  - Чекбокс "Збитий наповнювач"

- **Ступінь зносу** (дропдаун): 10%, 30%, 50%, 75%

##### Забруднення, дефекти та ризики

- **Плями** (мультиселект чекбоксів):

  - Жир, Кров, Білок, Вино, Кава, Трава, Чорнило, Косметика
  - Інше (з полем для уточнення)

- **Дефекти та ризики** (мультиселект чекбоксів):

  - Потертості, Порване, Відсутність фурнітури, Пошкодження фурнітури
  - Ризики зміни кольору, Ризики деформації
  - Без гарантій (з обов'язковим поясненням причин)

- **Примітки щодо дефектів** (текстове поле)

##### Експрес-модифікатори (чекбокси для швидкого застосування)

**Загальні коефіцієнти** (доступні для всіх категорій):

- Дитячі речі (до 30 розміру) - 30% від вартості
- Ручна чистка +20% до вартості
- Дуже забруднені речі +від 20 до 100% до вартості
- Термінова чистка +від 50 до 100% до вартості

**Модифікатори для текстильних виробів** (відображаються для відповідних категорій):

- Чистка виробів з хутряними комірами та манжетами +30%
- Нанесення водовідштовхуючого покриття +30%
- Чистка виробів із натурального шовку, атласу, шифону +50%
- Чистка комбінованих виробів (шкіра+текстиль) +100%
- Ручна чистка великих м'яких іграшок +100%
- Пришивання гудзиків (фіксована вартість за одиницю)
- Чистка виробів чорного та світлих тонів +20%
- Чистка весільної сукні зі шлейфом +30%

**Модифікатори для шкіряних виробів** (відображаються для шкіряних категорій):

- Прасування шкіряних виробів 70% від вартості чистки
- Нанесення водовідштовхуючого покриття +30%
- Фарбування (після нашої чистки) +50%
- Фарбування (після чистки деінде) 100% вартість чистки
- Чистка шкіряних виробів із вставками +30%
- Нанесення перламутрового покриття +30%
- Чистка натуральних дублянок на штучному хутрі -20%
- Ручна чистка виробів зі шкіри +30%

##### Фотодокументація

- **Завантаження фото**:
  - Кнопка "Камера" (використання WebRTC API)
  - Кнопка "Галерея" (input type="file" з accept="image/\*")
  - Попередній перегляд мініатюр з можливістю видалення
  - Обмеження: максимум 5 фото на предмет, до 5MB кожне
  - Автоматичне стиснення перед відправкою

#### 2.3. Інтерактивний калькулятор (знизу від форми)

- **Відображення розрахунків в реальному часі**:
  - Базова ціна (автоматично з прайсу)
  - Вплив кожного модифікатора (у відсотках та грошах)
  - Проміжні суми на кожному етапі
  - Фінальна ціна за предмет
- **Деталізація розрахунку** (згортається/розгортається)

### Секція 3: Підсумки та завершення (правий блок - 20%)

#### 3.1. Загальні параметри замовлення

- **Дата виконання**:

  - Календар з вибором дати
  - Автоматичний розрахунок на основі категорій доданих предметів
  - Інформація про стандартні терміни (48 годин для звичайних/14 днів для шкіри)

- **Термінове виконання** (дропдаун):
  - Звичайне (без націнки)
  - +50% за 48 год
  - +100% за 24 год
  - Автоматичний перерахунок дати виконання при зміні

#### 3.2. Знижки (глобальні для замовлення)

- **Тип знижки** (дропдаун):

  - Без знижки
  - Еверкард (10%)
  - Соцмережі (5%)
  - ЗСУ (10%)
  - Інше (з полем для вводу відсотка)

- **Важливе обмеження** (система перевіряє автоматично):
  - Знижки не діють на прасування, прання і фарбування текстилю
  - Відображення попередження якщо знижка не застосовується
  - Автоматичне виключення неприйнятних категорій

#### 3.3. Фінансовий блок

- **Розрахунки**:

  - Сума до знижки (автоматично)
  - Знижка (сума, якщо застосовується)
  - **Загальна вартість** (виділена)
  - Сплачено (поле для введення передоплати)
  - Борг (розраховується автоматично як різниця)

- **Спосіб оплати** (дропдаун):
  - Термінал
  - Готівка
  - На рахунок

#### 3.4. Завершення замовлення

- **Примітки до замовлення** (текстове поле)
- **Юридичні аспекти**:
  - Чекбокс "Я погоджуюсь з умовами надання послуг" (обов'язковий)
  - Посилання на державні документи
- **Цифровий підпис клієнта**:
  - Canvas область для підпису на сенсорному екрані
  - Кнопки "Очистити" та "Зберегти підпис"
- **Кнопка "ДРУК КВИТАНЦІЇ"** (велика, виділена кнопка)

## Структура квитанції (повна деталізація)

### Шапка квитанції

- Логотип хімчистки
- Назва та юридична інформація компанії
- Адреса та контактні дані
- Пункт прийому (філія)
- Прізвище та ініціали оператора

### Інформація про замовлення

- Номер квитанції
- Номер унікальної мітки
- Дата створення замовлення
- Орієнтовна дата видачі (чітко вказати "після 14:00")

### Інформація про клієнта

- ПІБ
- Контактний телефон
- Обраний спосіб зв'язку
- Адреса (якщо вказана)

### Таблиця предметів з повною деталізацією

- **Заголовки**: № | Найменування | Категорія | К-сть/Вага | Матеріал | Колір | Наповнювач | Базова ціна | Модифікатори | Фінальна ціна

- **Детальний розрахунок для кожного предмета**:
  - Базова ціна
  - Кожен застосований модифікатор з його впливом на ціну
  - Проміжні розрахунки
  - Фінальна ціна за предмет

### Розділ забруднень і дефектів

- Перелік виявлених плям (за типами)
- Перелік дефектів та ризиків
- Примітка "Без гарантій" (якщо застосовується) з поясненням

### Фінансова інформація

- Вартість послуг до знижок
- Знижка (якщо застосовується, з вказаним типом та сумою)
- Надбавка за терміновість (якщо застосовується)
- **Загальна вартість**
- Сплачено (передоплата)
- Залишок до сплати при отриманні
- Спосіб оплати

### Юридична інформація

- Стандартні умови надання послуг
- Обмеження відповідальності
- Інформація про можливі ризики
- Посилання на повні умови договору

### Підписи та печатки

- Місце для цифрового підпису клієнта (при здачі)
- Місце для підпису клієнта при отриманні
- Підпис оператора
- Печатка компанії (якщо застосовується)

### Нижній колонтитул

- Контактна інформація для зв'язку
- Графік роботи
- QR-код для відстеження статусу замовлення

## Логіка розрахунку вартості

### 1. Правила застосування знижок і надбавок

- Знижки на все замовлення не поширюються на послуги прання, прасування та фарбування текстилю
- Спочатку розраховуються надбавки за додаткові послуги, потім застосовуються знижки
- При накладанні кількох надбавок, вони додаються до базової ціни послідовно (не перемножуються)

### 2. Процес розрахунку вартості для кожного предмета

1. **Базова ціна** (з прайсу на основі категорії та найменування)
2. **Перевірка кольорових виробів** - різна ціна для чорного та інших кольорів
3. **Застосування особливих модифікаторів** - деякі можуть замінювати базову ціну
4. **Застосування множників** - коефіцієнти для матеріалу, стану, додаткових послуг
5. **Додавання фіксованих послуг** - наприклад, пришивання гудзиків
6. **Терміновість** (якщо вибрана): +50% або +100% до проміжної суми
7. **Знижки** (якщо застосовуються і дозволені для цієї категорії)
8. **Округлення** до копійок (2 знаки після коми)

### 3. Інтелектуальні залежності та автоматизація

- При виборі категорії автоматично оновлюється:

  - Список доступних найменувань
  - Список можливих матеріалів
  - Набір доступних додаткових послуг
  - Одиниця виміру (шт/кг)
  - Очікуваний термін виконання

- При виборі терміновості:

  - Автоматичний перерахунок вартості всіх предметів
  - Оновлення дати виконання

- При виборі певних типів забруднень:
  - Система автоматично пропонує відповідні додаткові послуги
  - Може з'явитися попередження про ризики

## Прозорість розрахунків в реальному часі

### 1. Інтерактивний калькулятор

- Відображення розрахунків під час заповнення форми
- Базова ціна + вплив кожного модифікатора
- Проміжні суми на кожному етапі
- Фінальна ціна за предмет з деталізацією

### 2. Загальний підсумок замовлення

- Сума по всіх предметах
- Загальні знижки та надбавки
- Фінальна сума до сплати
- Оновлення в реальному часі при змінах

### 3. Повна деталізація в квитанції

- Розгорнутий розрахунок для кожного предмета
- Чітке відображення всіх застосованих модифікаторів
- Прозорий розрахунок фінальної суми

## Інтеграція з базою даних

### 1. Структура прайс-листа

- **Категорії послуг** (ServiceCategory): ID, код, назва, опис
- **Прайс-лист** (PriceListItem): ID, категорія, номер, назва, одиниця виміру, базова ціна
- **Додаткові поля**: різні ціни для чорного/інших кольорів

### 2. Зберігання модифікаторів та коефіцієнтів

- Конфігурація модифікаторів на стороні бекенду
- Гнучка система застосування коефіцієнтів

### 3. Зберігання замовлень

- Повна деталізація розрахунків для кожного предмета
- Можливість відтворення розрахунку в будь-який момент
- Історія змін та аудит

## Технічні рекомендації

### 1. Адаптивний інтерфейс

- Responsive design для планшетів та десктопів
- Оптимізація для тач-інтерфейсу
- Спеціальні компоненти для швидкого вводу

### 2. Оптимізація продуктивності

- Кешування прайс-листа
- Lazy loading для великих списків
- Оптимізація розрахунків в реальному часі

### 3. UX/UI оптимізації

- Автозбереження введених даних
- Валідація в реальному часі
- Швидкі клавіатурні скорочення
- Інтуїтивна навігація між полями

## Технічна архітектура калькулятора

### 1. SMART Engine архітектура

**Двигун розрахунків використовує розумний вибір калькулятора:**

- **90% випадків**: SimpleCalculator - обробляє PERCENTAGE та FIXED_AMOUNT модифікатори
- **10% випадків**: JexlCalculator - обробляє складні JEXL правила для спеціальних бізнес-кейсів
- **Автоматичний вибір**: система сама визначає який калькулятор використати
- **Комбінування результатів**: при наявності обох типів модифікаторів

### 2. Структура DTO для калькуляції

#### ItemCalculationRequest (вхідні дані)

```yaml
priceListItemId: UUID # Ідентифікатор предмета з прайс-листа
quantity: Integer # Кількість предметів (мін. 1)
appliedModifiers: List<UUID> # Список модифікаторів для застосування
urgency: UrgencyType # Тип терміновості (NORMAL, URGENT_48H, URGENT_24H)

# МАЙБУТНІ РОЗШИРЕННЯ (для повної відповідності бізнес-логіці):
material: MaterialType # Матеріал (бавовна, шерсть, шовк, шкіра)
color: String # Колір (для різних цін чорного та інших кольорів)
filling: FillingType # Наповнювач (пух, синтепон, збитий)
wearDegree: WearDegreeType # Ступінь зносу (10%, 30%, 50%, 75%)
stains: List<StainType> # Плями (жир, кров, вино, кава, тощо)
defects: List<DefectType> # Дефекти (потертості, порване, фурнітура)
defectNotes: String # Примітки щодо дефектів
photos: List<PhotoUpload> # Фотодокументація (макс 5 фото по 5MB)
```

#### ItemCalculationResponse (результат розрахунку)

```yaml
priceListItemId: UUID # Ідентифікатор предмета
itemName: String # Назва предмета
quantity: Integer # Кількість
basePrice: Double # Базова ціна за одиницю
totalBasePrice: Double # Базова ціна за кількість
appliedModifiers: List<AppliedModifierResult> # Застосовані модифікатори
modifiersTotal: Double # Загальна сума модифікаторів
subtotal: Double # Проміжна сума
urgencyCharge: Double # Надбавка за терміновість
finalPrice: Double # Фінальна ціна
calculationSteps: List<CalculationStep> # Детальні кроки розрахунку
warnings: List<String> # Попередження щодо розрахунку
```

#### CalculationStep (крок розрахунку)

```yaml
step: String # Назва кроку ("Базова ціна", "Модифікатор X")
description: String # Опис кроку
amount: Double # Сума на цьому кроці
runningTotal: Double # Накопичена сума
```

### 3. Enum типи

#### UrgencyType (терміновість)

- **NORMAL**: Звичайне виконання (без націнки)
- **URGENT_48H**: Термінове 48 годин (+50%)
- **URGENT_24H**: Термінове 24 години (+100%)

#### ModifierType (типи модифікаторів)

- **PERCENTAGE**: Відсотковий модифікатор (наприклад, +30%)
- **FIXED_AMOUNT**: Фіксована сума (наприклад, +50 грн)

### 4. Алгоритм розрахунку (8 кроків)

```java
// 1. Базова ціна
Double basePrice = priceListItem.getBasePrice() * quantity;

// 2. Перевірка кольорових виробів (майбутнє розширення)
basePrice = adjustForColor(basePrice, color, priceListItem);

// 3-4. Застосування модифікаторів через SMART Engine
List<PriceModifierEntity> simpleModifiers = filterSimpleModifiers(modifiers);
List<PriceModifierEntity> jexlModifiers = filterJexlModifiers(modifiers);

CalculationResult result = simpleCalculator.calculate(basePrice, simpleModifiers);
if (!jexlModifiers.isEmpty()) {
    result = jexlCalculator.calculate(result.getFinalPrice(), jexlModifiers);
}

// 5. Фіксовані послуги (включені в модифікатори)
// 6. Терміновість
Double urgencyCharge = calculateUrgencyCharge(result.getFinalPrice(), urgency);
Double finalPrice = result.getFinalPrice() + urgencyCharge;

// 7. Знижки (на рівні замовлення, не предмета)
// 8. Округлення до копійок
finalPrice = Math.round(finalPrice * 100.0) / 100.0;
```

### 5. Складні бізнес-правила через JEXL

**Приклади JEXL формул для складних випадків:**

```javascript
// Комбіновані вироби (шкіра + текстиль)
"categoryCode == 'LEATHER_TEXTILE_COMBO' ? basePrice * 2.0 : basePrice";

// Весільна сукня зі шлейфом
"itemName.contains('весільна') && hasTrail ? basePrice * 1.3 : basePrice";

// Дитячі речі залежно від розміру
"size <= 30 ? basePrice * 0.7 : basePrice";
```

### 6. Правила знижок (Order-level)

**Типи знижок:**

- Без знижки (0%)
- Еверкард (10%)
- Соцмережі (5%)
- ЗСУ (10%)
- Інше (кастомний відсоток)

**ВАЖЛИВЕ ОБМЕЖЕННЯ:**
Знижки НЕ поширюються на:

- Прасування
- Прання білизни
- Фарбування текстилю

### 7. Інтеграція з Frontend

**API Endpoints:**

- `POST /api/items/calculate` - розрахунок ціни предмета
- `POST /api/items/preview` - попередній перегляд ціни
- `POST /api/orders/calculate-summary` - розрахунок замовлення

**Real-time розрахунки:**

- Використання Orval-генерованих хуків
- Автоматичне оновлення при зміні параметрів
- Відображення проміжних кроків розрахунку

## Висновок

Односторінкова система замовлень забезпечує:

- **Швидкість роботи** - всі функції на одному екрані
- **Прозорість розрахунків** - в реальному часі з детальною деталізацією
- **Повноту інформації** - детальна документація кожного кроку
- **Зручність використання** - оптимізована для операторів
- **Гнучкість налаштувань** - SMART Engine + JEXL для складних правил
- **Технічна надійність** - OpenAPI-first підхід з типобезпекою
