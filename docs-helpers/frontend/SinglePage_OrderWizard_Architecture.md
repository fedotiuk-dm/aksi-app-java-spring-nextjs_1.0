# Реалізація Order Wizard на одній сторінці з Orval

## Концепція підходу

**Максимально спрощена реалізація** - вся функціональність Order Wizard розміщується на одній сторінці з розбивкою на компоненти для зручності розробки. Використовуємо Orval для автоматичної інтеграції з backend API та простий стан для управління кроками.

## Архітектурні принципи

### 1. Одна сторінка - вся логіка

- Головна сторінка містить весь стан та координацію
- Компоненти виконують тільки UI функції
- Всі API виклики через Orval хуки в головній сторінці

### 2. Domain для функціональних елементів

- `domain/wizard` - хуки для роботи з API
- `domain/wizard` - типи та інтерфейси
- `domain/wizard` - допоміжні утиліти

### 3. Features для UI компонентів

- `features/order-wizard` - компоненти для кожного етапу
- Компоненти отримують дані через props
- Компоненти повертають зміни через callbacks

### 4. Orval як єдиний API шар

- Автоматична генерація хуків з OpenAPI схеми
- Типізація всіх даних з backend
- React Query для кешування та оптимізації

## Структура проекту

```
frontend/
├── domain/wizard/
│   ├── hooks/
│   │   ├── useOrderWizardData.ts     # Центральний хук для всіх даних
│   │   ├── useClientOperations.ts    # Операції з клієнтами
│   │   ├── useItemOperations.ts      # Операції з предметами
│   │   └── useOrderOperations.ts     # Фінальні операції замовлення
│   ├── types/
│   │   ├── wizard.types.ts           # Типи для стану візарда
│   │   └── steps.types.ts            # Типи для кроків
│   └── utils/
│       ├── stepValidation.ts         # Валідація кроків
│       ├── priceCalculation.ts       # Розрахунки цін
│       └── wizardFlow.ts             # Логіка переходів
│
├── features/order-wizard/
│   ├── ui/
│   │   ├── OrderWizardPage.tsx       # Головна сторінка
│   │   ├── ClientSelectionStep.tsx   # Крок 1: Клієнт
│   │   ├── ItemManagerStep.tsx       # Крок 2: Предмети
│   │   ├── ItemSubWizard.tsx         # Підвізард предмета
│   │   ├── OrderParametersStep.tsx   # Крок 3: Параметри
│   │   ├── ConfirmationStep.tsx      # Крок 4: Підтвердження
│   │   └── WizardNavigation.tsx      # Навігація між кроками
│   └── components/
│       ├── ClientSearch.tsx          # Пошук клієнтів
│       ├── ClientForm.tsx            # Форма клієнта
│       ├── ItemsList.tsx             # Список предметів
│       ├── ItemForm.tsx              # Форма предмета
│       ├── PriceCalculator.tsx       # Калькулятор ціни
│       └── ReceiptPreview.tsx        # Перегляд квитанції
│
└── shared/api/generated/             # Orval згенеровані файли
    └── order-wizard/zod/
        ├── orderWizard.ts           # API хуки
        ├── orderWizard.schemas.ts   # Zod схеми
        └── index.ts                 # Експорти
```

## Логіка головної сторінки OrderWizardPage

### Централізований стан

Головна сторінка управляє всім станом Order Wizard:

- **Поточний крок** - який етап зараз активний
- **Дані клієнта** - пошук, вибраний клієнт, новий клієнт
- **Список предметів** - додані предмети замовлення
- **Поточний предмет** - предмет який зараз додається/редагується
- **Параметри замовлення** - дата, терміновість, знижки, оплата
- **Статус кроків** - які кроки завершені, валідація

### Інтеграція з Orval хуками

Всі API операції через автоматично згенеровані хуки:

- **Довідкові дані**: категорії сервісів, філії, модифікатори цін
- **Клієнти**: пошук, створення, оновлення
- **Предмети**: розрахунок ціни, завантаження фото
- **Замовлення**: створення, генерація квитанції, відправка email

### Координація між компонентами

Головна сторінка передає в компоненти:

- Дані для відображення
- Стани завантаження та помилок
- Callback функції для змін

## Етапи Order Wizard

### Етап 1: Клієнт та базова інформація (ClientSelectionStep)

**Функціональність:**

- Пошук існуючих клієнтів
- Створення нового клієнта
- Вибір філії прийому
- Введення базової інформації замовлення

**Компоненти:**

- `ClientSearch` - поле пошуку та список результатів
- `ClientForm` - форма для нового клієнта
- Селектор філії
- Поля номера квитанції та унікальної мітки

**Orval хуки:**

- `useSearchClients` - реактивний пошук при вводі
- `useCreateClient` - створення нового клієнта
- `useGetAllBranches` - список філій

**Автоматизація:**

- Автоматичний перехід до кроку 2 при виборі клієнта
- Валідація обов'язкових полів перед переходом

### Етап 2: Менеджер предметів (ItemManagerStep)

**Функціональність:**

- Відображення списку доданих предметів
- Додавання нових предметів через підвізард
- Редагування існуючих предметів
- Видалення предметів
- Відображення загальної вартості

**Компоненти:**

- `ItemsList` - таблиця доданих предметів з діями
- `ItemSubWizard` - повний підвізард додавання предмета
- Індикатор загальної вартості

**Підвізард предмета (ItemSubWizard):**

**Підетап 2.1: Основна інформація**

- Вибір категорії послуги
- Вибір найменування з прайсу
- Введення кількості/ваги

**Підетап 2.2: Характеристики**

- Вибір матеріалу
- Введення кольору
- Вибір наповнювача (для відповідних категорій)
- Ступінь зносу

**Підетап 2.3: Забруднення та дефекти**

- Мультивибір типів плям
- Мультивибір дефектів та ризиків
- Примітки до дефектів

**Підетап 2.4: Модифікатори та ціна**

- Вибір додаткових послуг
- Автоматичний розрахунок ціни
- Деталізація впливу модифікаторів

**Підетап 2.5: Фотодокументація**

- Завантаження фото з камери або галереї
- Попередній перегляд
- Обмеження кількості та розміру

**Orval хуки:**

- `useGetAllServiceCategories` - категорії послуг
- `useGetPriceListByCategory` - предмети за категорією
- `useGetAllPriceModifiers` - модифікатори цін
- `useCalculateItemPrice` - розрахунок ціни предмета
- `useUploadPhoto` - завантаження фото

### Етап 3: Параметри замовлення (OrderParametersStep)

**Функціональність:**

- Вибір дати виконання
- Налаштування терміновості
- Вибір типу знижки
- Налаштування способу оплати
- Введення передоплати
- Додаткові примітки

**Компоненти:**

- Календар вибору дати
- Селектори терміновості та знижок
- Поля оплати
- Текстове поле примітків

**Автоматизація:**

- Автоматичний розрахунок дати виконання на основі предметів
- Перерахунок загальної суми при зміні знижок/терміновості
- Валідація застосування знижок до категорій

### Етап 4: Підтвердження та квитанція (ConfirmationStep)

**Функціональність:**

- Перегляд повного підсумку замовлення
- Деталізація розрахунків
- Цифровий підпис клієнта
- Генерація та друк квитанції
- Відправка копії на email

**Компоненти:**

- `ReceiptPreview` - повний перегляд квитанції
- Компонент цифрового підпису
- Кнопки дій з квитанцією

**Orval хуки:**

- `useCreateOrder` - фінальне створення замовлення
- `useGenerateReceipt` - генерація квитанції
- `useSendReceiptByEmail` - відправка на email

## Domain хуки для координації

### useOrderWizardData - центральний хук

**Відповідальність:**

- Завантаження всіх довідкових даних при старті
- Кешування статичних даних
- Обробка глобальних помилок завантаження

**Повертає:**

- Категорії сервісів, філії, модифікатори
- Стани завантаження та помилок
- Функції перезавантаження даних

### useClientOperations - операції з клієнтами

**Відповідальність:**

- Реактивний пошук клієнтів
- Створення та оновлення клієнтів
- Кешування результатів пошуку

**Повертає:**

- Результати пошуку
- Функції створення/оновлення
- Стани операцій

### useItemOperations - операції з предметами

**Відповідальність:**

- Розрахунок ціни предметів
- Завантаження фото
- Валідація даних предметів

**Повертає:**

- Функції розрахунку ціни
- Функції завантаження фото
- Результати валідації

### useOrderOperations - операції замовлення

**Відповідальність:**

- Створення фінального замовлення
- Генерація документів
- Відправка на email

**Повертає:**

- Функції створення замовлення
- Функції генерації документів
- Статуси операцій

## Навігація між кроками

### WizardNavigation компонент

**Функціональність:**

- Індикатор поточного кроку
- Кнопки навігації (Назад/Далі)
- Валідація можливості переходу
- Показ прогресу виконання

**Логіка переходів:**

- Автоматичні переходи при готовності даних
- Ручні переходи через навігацію
- Блокування переходу при незавершених кроках
- Збереження стану при поверненні назад

### Валідація кроків

**Крок 1 → Крок 2:**

- Клієнт обраний або створений
- Філія вибрана
- Базова інформація заповнена

**Крок 2 → Крок 3:**

- Хоча б один предмет додано
- Всі предмети мають розраховану ціну

**Крок 3 → Крок 4:**

- Дата виконання вибрана
- Спосіб оплати визначений

**Крок 4 → Завершення:**

- Цифровий підпис отриманий
- Умови послуг прийняті

## Управління станом

### Простий useState підхід

Замість складних state management рішень використовуємо простий стан:

- Кожен крок має свій об'єкт стану
- Зміни передаються через callback функції
- Валідація відбувається при спробі переходу
- Автозбереження критичних даних

### Збереження стану

- Чернетки замовлень зберігаються локально
- Відновлення при перезавантаженні сторінки
- Очищення при успішному завершенні

## Інтеграція з Orval

### Автоматична генерація з OpenAPI

Orval автоматично створює з backend OpenAPI схеми:

- TypeScript типи для всіх DTO
- React Query хуки для всіх endpoints
- Zod схеми для валідації форм
- Mock Service Worker для тестів

### Конфігурація кешування

- Статичні дані (категорії, філії) - довготривалий кеш
- Пошукові запити - короткотривалий кеш
- Мутації - без кешування
- Автоматичне оновлення при змінах

### Обробка помилок

- Автоматична обробка HTTP статусів
- Локалізовані повідомлення
- Retry логіка для критичних операцій
- Graceful degradation при недоступності API

## Переваги підходу

### Простота розробки

- Вся логіка в одному місці
- Мінімум абстракцій
- Пряма інтеграція з backend
- Швидкий debugging

### Продуктивність

- Автоматичне кешування через React Query
- Оптимістичні оновлення
- Ледаче завантаження компонентів
- Мінімальні re-render

### Підтримка

- Зрозумілий код без прихованої логіки
- Простий рефакторинг
- Легке додавання нових функцій
- Автоматична типізація

### Тестування

- Прості unit тести UI компонентів
- Інтеграційні тести з автоматичними моками
- E2E тести повного флоу
- Автоматична валідація API контрактів

## Обмеження підходу

### Масштабування

- Підходить для невеликих команд
- При зростанні складності потрібен рефакторинг
- Не підходить для переиспользування логіки

### Архітектурна гнучкість

- Жорстка прив'язка до конкретного флоу
- Складно адаптувати для інших процесів
- Важко змінювати порядок кроків

## Рекомендації по реалізації

### Етапи розробки

1. Налаштування Orval та генерація API хуків
2. Створення основної структури сторінки
3. Реалізація кроку 1 (найпростіший)
4. Реалізація підвізарда предметів (найскладніший)
5. Додавання решти кроків
6. Інтеграція навігації та валідації
7. Тестування повного флоу

### Принципи розробки

- Починати з найпростіших компонентів
- Використовувати Orval хуки як є, без обгорток
- Додавати валідацію поступово
- Тестувати кожен крок окремо

Цей підхід забезпечує швидку розробку функціонального Order Wizard з мінімальною складністю архітектури при збереженні всіх необхідних функцій для хімчистки.
