# План рефакторингу для виправлення дублювання коду

## Огляд проблеми

Згідно зі звітом інструменту CPD (Copy-Paste Detector), в проекті було виявлено значну кількість випадків дублювання коду. Це призводить до:

1. Складнощів з підтримкою (зміни потрібно вносити в багатьох місцях)
2. Підвищення ризику помилок (при оновленні логіки в одному місці, але не в іншому)
3. Збільшення об'єму кодової бази
4. Ускладнення розуміння та аналізу коду

## Пріоритетні зони рефакторингу

Нижче наведено список класів з найбільшою кількістю дубльованого коду, впорядкований за пріоритетом:

### 1. ✅ AuthService

- **Опис проблеми**: 21 рядок дубльованого коду між методами (лінії 70 та 110), два додаткові блоки по 11 рядків.
- **План рефакторингу**: Винести логіку генерації токенів та аутентифікації в окремі приватні допоміжні методи.
- **Статус**: ✅ Виконано. Створено допоміжні методи:
  - `findUserByUsernameOrEmail` - для пошуку користувача за ім'ям/email
  - `findUserByUsername` - для пошуку користувача за ім'ям
  - `createAuthResponseForUser` - для створення відповіді з токенами

### 2. PriceModifierCalculationServiceImpl

- **Опис проблеми**: 20 рядків дубльованого коду між методами (лінії 89 та 126) та 17 рядків дубльованого коду між лініями 172 та 216.
- **План рефакторингу**: Створити утилітні методи для обчислення цін та роботи з модифікаторами.

### 3. ✅ BranchLocationCreateRequest та BranchLocationUpdateRequest

- **Опис проблеми**: 26 рядків дубльованого коду з полями та валідаторами.
- **План рефакторингу**: Створити базовий абстрактний клас `BaseBranchLocationRequest` зі спільними полями та валідаторами.
- **Статус**: ✅ Виконано. Створено абстрактний клас `BaseBranchLocationRequest` та оновлено дочірні класи.

### 4. ✅ CreateClientRequest та UpdateClientRequest

- **Опис проблеми**: 29 рядків дубльованого коду в DTO для клієнтських запитів.
- **План рефакторингу**: Створити базовий абстрактний клас `BaseClientRequest` зі спільними полями та валідаторами.
- **Статус**: ✅ Виконано. Створено:
  - `BaseClientRequest` - абстрактний клас зі спільними полями та валідаторами
  - Оновлено `CreateClientRequest` з додатковими валідаціями для обов'язкових полів
  - Оновлено `UpdateClientRequest` для наслідування базового класу

### 5. ✅ OrderMapper

- **Опис проблеми**: 20 рядків дубльованого коду між методами (лінії 35 та 55).
- **План рефакторингу**: Винести дублюючі маппінги в окремі методи або використати спадкування мапперів.
- **Статус**: ✅ Виконано. Створено спільний метод `mapOrderCommonFields` з усіма анотаціями @Mapping, який використовується для обох методів.

### 6. ✅ GlobalExceptionHandler

- **Опис проблеми**: 17 рядків дубльованого коду в обробці винятків.
- **План рефакторингу**: Створити загальний метод для обробки однотипних винятків.
- **Статус**: ✅ Виконано. Створено метод `handleStandardException`, який викликається з обробників конкретних винятків, що дозволяє уникнути дублювання.

### 7. AbstractDefectTypeService та AbstractStainTypeService

- **Опис проблеми**: 14 рядків дубльованого коду в методах.
- **План рефакторингу**: Перенести спільну логіку в спільний абстрактний батьківський клас.

## План виконання рефакторингу

### Етап 1: AuthService та PriceModifierCalculationServiceImpl

1. **Задача**: ✅ Рефакторинг AuthService

   - ✅ Створити допоміжні методи для генерації токенів
   - ✅ Об'єднати повторювану логіку аутентифікації

2. **Задача**: Рефакторинг PriceModifierCalculationServiceImpl
   - Створити утилітні методи для застосування модифікаторів
   - Уніфікувати логіку обчислення в шаблонних методах

### Етап 2: Рефакторинг DTO класів

1. **Задача**: ✅ Створити базові класи запитів для філій

   - ✅ Створити `BaseBranchLocationRequest`
   - ✅ Оновити дочірні класи для успадкування

2. **Задача**: ✅ Створити базові класи запитів для клієнтів
   - ✅ Створити `BaseClientRequest`
   - ✅ Оновити дочірні класи для успадкування

### Етап 3: Рефакторинг мапперів

1. **Задача**: ✅ Покращення OrderMapper
   - ✅ Винести спільну логіку маппінгу в окремі методи
   - ✅ Уникнути дублювання анотацій, створюючи шаблонний метод

### Етап 4: Рефакторинг обробки винятків

1. **Задача**: ✅ Покращення GlobalExceptionHandler
   - ✅ Реалізувати шаблонний метод для обробки однотипних винятків

### Етап 5: Додаткові покращення

1. **Задача**: Рефакторинг AbstractDefectTypeService та AbstractStainTypeService
   - Перенести дублюючі методи в абстрактний батьківський клас

## Очікувані результати

- Зменшення загального обсягу коду
- Покращення структури проекту
- Спрощення подальшої підтримки
- Зменшення ризику появи помилок при оновленні логіки
