# Новий підхід до реалізації OrderWizard

## Детальний аналіз поточного стану

OrderWizard є складною багатоетапною системою з кількома ключовими проблемами:

1. **Складність стану** - 4 основні етапи з численними підетапами та циклічністю
2. **Взаємозалежність даних** - зміни на одному етапі впливають на інші етапи
3. **Складні розрахунки** - ціноутворення з багатьма коефіцієнтами та модифікаторами
4. **Валідація** - численні правила валідації для різних типів даних

## Новий підхід з використанням наявних бібліотек

Пропонуємо архітектуру на основі:

### 1. Керування станом через Zustand

Zustand ідеально підходить для моделювання складного процесу Wizard з чіткими станами і переходами:

- **Візуалізація процесу** - можливість наочно бачити всі стани та переходи
- **Передбачуваність** - чітка логіка переходів між станами
- **Тестування** - легко тестувати кожен стан окремо

### 2. Форми через React Hook Form + Zod

- **Валідація на основі схем** - визначення схем для кожного етапу
- **Типобезпека** - генерація TypeScript типів з Zod схем
- **Продуктивність** - нетривіальна оптимізація рендеринга

### 3. Запити до API через TanStack Query

- **Кешування** - автоматичне кешування результатів запитів
- **Управління станами** - стани завантаження, помилок, успіху
- **Інвалідація кешу** - оновлення даних при їх зміні
- **Обовязкове використання OpenAPI** - обовязкове використання /lib/api OpenAPI

## Кореневий рівень фічі

```
features/
└── order-wizard/
    ├── index.ts                     # Головний експорт фічі
    ├── OrderWizard.tsx              # Головний контейнер візарду
    ├── model/                       # Модель даних і машини станів
    ├── api/                         # API взаємодія
    ├── lib/                         # Бізнес-логіка
    ├── hooks/                       # React хуки
    ├── ui/                          # UI компоненти
    └── contexts/                    # React контексти 
```

## Ключові рішення для уникнення повторень (DRY)

### 1. Універсальні компоненти

- **WizardStep** - універсальний компонент для будь-якого етапу з валідацією
- **ItemTable** - повторно використовуваний компонент для відображення предметів
- **PhotoUploader** - єдиний компонент для всіх операцій з фото

### 2. Зменшення дублювання коду

- **useFieldArray** з React Hook Form для управління динамічними списками
- **Zustand контекст** для глобального стану замовлення
- **TanStack Query** для уникнення дублювання логіки запитів

### 3. Розділення відповідальності (SOLID)

- **Окремі хуки** для кожної бізнес-функції
- **Окремі компоненти** для кожного етапу
- **model/schema.ts** - валідація відокремлена від UI
- **api/pricing.ts** - розрахунки виконуються на бекенді

## Схема машини станів Zustand

Zustand допоможе моделювати процес OrderWizard з чіткими переходами:

1. **clientSelection** → Вибір або створення клієнта
2. **basicInfo** → Заповнення базової інформації
3. **itemManagement** → Головний екран списку предметів
   - **addingItem** → Підстан для додавання предмета
     - **itemBasic** → Основна інформація про предмет
     - **itemProperties** → Характеристики предмета
     - **defects** → Забруднення та дефекти
     - **pricing** → Розрахунок ціни
     - **photos** → Фотодокументація
   - **editingItem** → Підстан для редагування предмета
   - **reviewingItems** → Підстан для перегляду предметів
4. **orderParams** → Загальні параметри замовлення
5. **billing** → Платіжна інформація та квитанція
6. **complete** → Завершення замовлення

## Практична реалізація з використанням бібліотек

### Zustand: Визначення машини станів

При створенні машини станів для OrderWizard, ми зробимо акцент на чіткому визначенні переходів та контексту, що містить дані замовлення:

- **Контекст** - міститиме всі дані замовлення та проміжні форми
- **Події** - чітко визначені команди для переходів між станами
- **Дії** - обробка даних при переходах
- **Сервіси** - асинхронні операції, такі як запити до API

### React Hook Form + Zod: Валідація форм

Для валідації даних використаємо Zod схеми, які також спростять визначення типів для TypeScript:

- **Схема клієнта** - валідація даних клієнта
- **Схема предмета** - валідація даних предметів
- **Схема замовлення** - валідація загальних параметрів замовлення

Кожна форма використовуватиме ці схеми через `useForm` з React Hook Form та `zodResolver`.

### TanStack Query: Оптимізація запитів

API-хуки будуть побудовані з використанням TanStack Query для оптимізації:

- **useQuery** - для отримання даних (клієнти, прайс-лист тощо)
- **useMutation** - для створення/оновлення даних
- **useInfiniteQuery** - для пагінації при пошуку клієнтів
- **Invalidation** - для оновлення кешу після мутацій

## Висновок та наступні кроки

Новий підхід дозволить:
1. Зробити код **модульним** та **легко тестованим**
2. **Спростити управління** складним станом
3. **Покращити UX** завдяки чіткому процесу
4. **Зменшити кількість помилок** завдяки типобезпеці
5. **Спростити дебаг** з інструментами візуалізації Zustand

Рекомендуємо почати з:
1. Визначення Zod схем для валідації даних
2. Проектування машини станів Zustand
3. Розробки базових UI компонентів
4. Інтеграції API хуків з TanStack Query

Цей підхід значно покращить структуру коду та зробить його більш дотримуваним принципів FSD та SOLID.

### Модель даних і бізнес-логіка

model/
├── types/                           # Типи даних
│   ├── index.ts                     # Експорт всіх типів
│   ├── client.types.ts              # Типи клієнта
│   ├── item.types.ts                # Типи предметів
│   ├── order.types.ts               # Типи замовлення
│   ├── pricing.types.ts             # Типи для ціноутворення
│   └── wizard.types.ts              # Типи для стану візарду
├── schema/                          # Zod схеми для валідації
│   ├── index.ts                     # Експорт всіх схем
│   ├── client.schema.ts             # Схеми клієнта
│   ├── item.schema.ts               # Схеми предметів
│   ├── order.schema.ts              # Схеми замовлення
│   └── pricing.schema.ts            # Схеми для ціноутворення
├── constants/                       # Константи
│   ├── index.ts                     # Експорт всіх констант
│   ├── categories.constants.ts      # Категорії предметів
│   ├── materials.constants.ts       # Матеріали
│   ├── defects.constants.ts         # Типи дефектів
│   ├── stains.constants.ts          # Типи плям
│   ├── discounts.constants.ts       # Типи знижок
│   └── payment.constants.ts         # Способи оплати
├── machine/                         # Zustand машини станів
│   ├── index.ts                     # Експорт машин станів
│   ├── orderWizard.machine.ts       # Головна машина візарду
│   ├── itemWizard.machine.ts        # Машина для додавання предмета
│   └── actions.ts                   # Дії для машин станів
└── formulas/                        # Формули для розрахунків
    ├── index.ts                     # Експорт всіх формул
    ├── base-price.ts                # Розрахунок базової ціни
    ├── modifiers.ts                 # Розрахунок модифікаторів
    ├── discounts.ts                 # Розрахунок знижок
    └── total.ts                     # Розрахунок загальної вартості

### API інтеграція

api/
├── index.ts                       # Експорт всіх API функцій
├── hooks/                         # Хуки, що використовують згенерований API
│   ├── index.ts                   # Експорт всіх хуків
│   ├── useClientApi.ts            # Хуки для роботи з API клієнтів
│   ├── useOrderApi.ts             # Хуки для роботи з API замовлень
│   ├── useItemApi.ts              # Хуки для роботи з API предметів
│   └── usePricingApi.ts           # Хуки для роботи з API ціноутворення
└── adapters/                      # Адаптери для перетворення даних
    ├── index.ts                   # Експорт всіх адаптерів
    ├── clientAdapter.ts           # Адаптація даних клієнта між UI та API
    ├── itemAdapter.ts             # Адаптація даних предметів
    ├── orderAdapter.ts            # Адаптація даних замовлення
    └── priceAdapter.ts            # Адаптація даних ціноутворення

### Клієнтські утиліти

lib/
├── index.ts                         # Експорт всіх утиліт
├── storage/                         # Локальне збереження стану
│   ├── index.ts                     # Експорт сховищ
│   ├── wizardStorage.ts             # Збереження стану візарду
│   └── draftStorage.ts              # Збереження чернеток
├── adapters/                        # Адаптери для UI <-> API
│   ├── index.ts                     # Експорт всіх адаптерів  
│   └── formAdapters.ts              # Адаптація даних форм
└── helpers/                         # Допоміжні функції UI
    ├── index.ts                     # Експорт всіх хелперів
    ├── formatters.ts                # Форматування для відображення
    ├── validators.ts                # Додаткова валідація на клієнті
    └── utils.ts                     # Загальні утиліти

### React хуки

hooks/
├── index.ts                         # Експорт всіх хуків
├── state/                           # Хуки для роботи зі станом
│   ├── useOrderWizardState.ts       # Хук для доступу до стану візарду
│   ├── useItemWizardState.ts        # Хук для стану підвізарду предметів
│   └── useWizardNavigation.ts       # Хук для навігації між станами
├── api/                             # Хуки для роботи з API
│   ├── useClientSearch.ts           # Пошук клієнтів з пагінацією
│   ├── useClientCreate.ts           # Створення клієнта
│   ├── useOrderItems.ts             # Управління предметами замовлення
│   └── useOrderCreate.ts            # Створення замовлення
├── form/                            # Хуки для роботи з формами
│   ├── useClientForm.ts             # Хук для форми клієнта
│   ├── useItemBasicForm.ts          # Хук для форми основної інформації
│   ├── useItemPropertiesForm.ts     # Хук для форми характеристик
│   ├── useDefectsForm.ts            # Хук для форми дефектів
│   └── useOrderParamsForm.ts        # Хук для форми параметрів
└── business/                        # Хуки для бізнес-логіки
    ├── usePriceCalculation.ts       # Розрахунок цін
    ├── useDiscounts.ts              # Робота зі знижками
    ├── useDeadlineCalculation.ts    # Розрахунок термінів
    └── usePhotoManagement.ts        # Управління фотографіями

### UI компоненти

ui/
├── main/                            # Основні компоненти візарду
│   ├── OrderWizard.tsx              # Головний компонент візарду
│   ├── WizardNavigation.tsx         # Навігаційна панель
│   ├── WizardProgress.tsx           # Індикатор прогресу
│   └── WizardHeader.tsx             # Шапка візарду
├── steps/                           # Компоненти для етапів візарду
│   ├── step1-client-selection/      # Компоненти для Етапу 1.1
│   │   ├── ClientSelection.tsx      # Вибір клієнта
│   │   ├── ClientSearch.tsx         # Пошук клієнта
│   │   ├── ClientList.tsx           # Список знайдених клієнтів
│   │   └── ClientCreateForm.tsx     # Форма створення клієнта
│   ├── step2-basic-info/            # Компоненти для Етапу 1.2
│   │   ├── BasicInfoForm.tsx        # Форма базової інформації
│   │   └── ReceiptNumberField.tsx   # Поле номера квитанції
│   ├── step3-item-manager/          # Компоненти для Етапу 2.0
│   │   ├── ItemManager.tsx          # Менеджер предметів
│   │   ├── ItemsTable.tsx           # Таблиця предметів
│   │   └── ItemSummary.tsx          # Підсумок предметів
│   ├── step4-item-wizard/           # Компоненти для підетапів 2.1-2.5
│   │   ├── ItemWizard.tsx           # Підвізард предметів
│   │   ├── ItemBasicInfo.tsx        # Форма основної інформації
│   │   ├── ItemProperties.tsx       # Форма характеристик
│   │   ├── ItemDefects.tsx          # Форма дефектів
│   │   ├── ItemPricing.tsx          # Форма ціноутворення
│   │   └── ItemPhotos.tsx           # Форма фотодокументації
│   ├── step5-order-params/          # Компоненти для Етапу 3
│   │   ├── OrderParams.tsx          # Параметри замовлення
│   │   ├── DeadlineSettings.tsx     # Налаштування термінів
│   │   ├── DiscountSettings.tsx     # Налаштування знижок
│   │   └── PaymentSettings.tsx      # Налаштування оплати
│   └── step6-billing/               # Компоненти для Етапу 4
│       ├── OrderConfirmation.tsx    # Підтвердження замовлення
│       ├── OrderSummary.tsx         # Підсумок замовлення
│       ├── LegalAgreement.tsx       # Юридична інформація
│       ├── ClientSignature.tsx      # Підпис клієнта
│       └── ReceiptPreview.tsx       # Перегляд квитанції
├── common/                          # Повторно використовувані компоненти
│   ├── forms/                       # Спільні компоненти форм
│   │   ├── WizardStep.tsx           # Обгортка для етапу візарду
│   │   ├── FormSection.tsx          # Розділ форми
│   │   ├── FormActions.tsx          # Кнопки форми
│   │   ├── ValidationMessage.tsx    # Повідомлення про помилки
│   │   └── FormCheckboxGroup.tsx    # Група чекбоксів
│   ├── data-display/                # Компоненти відображення даних
│   │   ├── ItemTable.tsx            # Таблиця предметів
│   │   ├── PriceDisplay.tsx         # Відображення цін
│   │   ├── DetailsExpander.tsx      # Розгортання деталей
│   │   └── ClientInfoCard.tsx       # Картка інформації про клієнта
│   ├── inputs/                      # Компоненти вводу
│   │   ├── SearchInput.tsx          # Поле пошуку
│   │   ├── CategorySelect.tsx       # Вибір категорії
│   │   ├── ItemSelect.tsx           # Вибір предмета
│   │   ├── MaterialSelect.tsx       # Вибір матеріалу
│   │   ├── ColorSelect.tsx          # Вибір кольору
│   │   └── QuantityInput.tsx        # Ввід кількості
│   └── media/                       # Компоненти для медіа
│       ├── PhotoUploader.tsx        # Завантаження фото
│       ├── PhotoPreview.tsx         # Попередній перегляд фото
│       ├── PhotoGallery.tsx         # Галерея фото
│       └── SignatureCanvas.tsx      # Полотно для підпису
└── modals/                          # Модальні вікна
    ├── ItemDeleteConfirm.tsx        # Підтвердження видалення
    ├── PhotoAnnotation.tsx          # Анотування фото
    ├── PriceBreakdown.tsx           # Детальний розрахунок ціни
    └── DiscountWarning.tsx          # Попередження про знижки

### React контексти та глобальний стан

contexts/
├── index.ts                         # Експорт всіх контекстів
├── OrderWizardStateContext.tsx      # Контекст стану візарду з Zustand
├── ItemWizardStateContext.tsx       # Контекст стану підвізарду предметів
├── OrderDataContext.tsx             # Контекст даних замовлення
└── WizardUIContext.tsx              # Контекст UI візарду