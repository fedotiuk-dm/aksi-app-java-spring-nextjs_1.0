# Специфікація централізованого калькулятора вартості для хімчистки

## 1. Огляд та призначення

Централізований калькулятор вартості послуг хімчистки — це єдиний компонент системи, що інкапсулює всю логіку розрахунку цін для різних типів послуг та предметів. Мета компонента — забезпечити уніфікований, прозорий та надійний спосіб обчислення цін на всіх етапах обробки замовлення.

## 2. Функціональні вимоги

### 2.1. Базові можливості

- Розрахунок базової вартості предмета на основі його категорії та типу
- Застосування модифікаторів вартості на основі додаткових характеристик предмета
- Підтримка як відсоткових надбавок/знижок, так і фіксованих сум
- Обчислення глобальних знижок на рівні замовлення
- Обробка надбавок за терміновість замовлення
- Формування детального розрахунку з поясненням кожного кроку

### 2.2. Специфічні правила розрахунку

- Підтримка правил виключення знижок для певних категорій (прання, прасування, фарбування текстилю)
- Реалізація каскадного застосування модифікаторів (послідовне додавання, а не перемножування)
- Врахування специфічних правил для різних категорій послуг
- Динамічне визначення переліку доступних модифікаторів на основі типу предмета

## 3. Архітектурний дизайн

### 3.1. Основні компоненти

#### PriceCalculator
- Головний сервіс, що координує процес розрахунку
- Надає публічні методи для розрахунку як окремих предметів, так і цілих замовлень
- Реалізує стратегію послідовного застосування правил розрахунку

#### PriceCalculationResult
- Структура даних для зберігання результату розрахунку
- Містить як фінальну суму, так і покрокову деталізацію розрахунку
- Підтримує форматований виведення для демонстрації клієнту

#### PriceRulesProvider
- Постачальник правил розрахунку з бази даних або конфігурації
- Управління прайс-листом та модифікаторами
- Надання правил розрахунку для конкретних категорій та предметів

### 3.2. Взаємодія компонентів

1. Контролер або сервіс Order Wizard звертається до PriceCalculator
2. PriceCalculator отримує необхідні дані про предмет та замовлення
3. PriceCalculator запитує відповідні правила з PriceRulesProvider
4. Виконується послідовне застосування правил і модифікаторів
5. Формується детальний PriceCalculationResult
6. Результат повертається для відображення та збереження

## 4. Алгоритм розрахунку вартості

### 4.1. Розрахунок для окремого предмета

1. **Визначення базової ціни**:
   - Отримання базової ціни з прайсу за категорією та найменуванням
   - Перевірка корегування базової ціни (наприклад, для чорних та світлих виробів)

2. **Застосування специфічних модифікаторів**:
   - Перевірка на спеціальні умови (наприклад, "Фарбування після чистки деінде")
   - Заміна або модифікація базової ціни за необхідності

3. **Послідовне застосування відсоткових модифікаторів**:
   - Послідовне додавання модифікаторів до накопиченої суми
   - Для кожного модифікатора: Ціна += Ціна * (Модифікатор / 100)
   - Детальне протоколювання впливу кожного модифікатора

4. **Додавання фіксованих послуг**:
   - Додавання фіксованих сум за додаткові послуги (наприклад, пришивання гудзиків)

5. **Застосування терміновості**:
   - Додавання надбавки за терміновість (+50% або +100%)

6. **Округлення проміжного результату**:
   - Округлення до двох знаків після коми

### 4.2. Розрахунок на рівні замовлення

1. **Обчислення суми за всіма предметами**:
   - Підсумовування результатів розрахунку для всіх предметів

2. **Перевірка можливості застосування знижок**:
   - Визначення предметів, до яких не можна застосовувати знижку
   - Розділення загальної суми на дві частини: з можливою знижкою та без неї

3. **Застосування глобальної знижки**:
   - Застосування знижки лише до частини замовлення, де це дозволено

4. **Формування підсумкового розрахунку**:
   - Обчислення фінальної суми
   - Створення детального протоколу розрахунку

## 5. Структури даних для деталізації розрахунку

### 5.1. DetailedItemCalculation (деталізація для предмета)

- **basePrice**: Базова ціна
- **modifiers**: Список застосованих модифікаторів:
  - name: Назва модифікатора
  - percentage: Відсоток впливу (для відсоткових модифікаторів)
  - amount: Сума впливу
  - description: Опис модифікатора
- **intermediateResults**: Проміжні результати на кожному етапі
- **finalPrice**: Фінальна ціна предмета

### 5.2. OrderPriceCalculation (деталізація для замовлення)

- **itemCalculations**: Список деталізацій для кожного предмета
- **subtotalBeforeDiscount**: Загальна сума до знижки
- **discountableAmount**: Сума, до якої можна застосувати знижку
- **nonDiscountableAmount**: Сума, до якої не можна застосувати знижку
- **discountDetails**: Деталі застосованої знижки
- **urgencyDetails**: Деталі надбавки за терміновість
- **finalTotal**: Фінальна сума замовлення
- **paidAmount**: Сплачена сума
- **remainingAmount**: Залишок до сплати

## 6. Інтеграція з іншими компонентами системи

### 6.1. Взаємодія з Order Wizard

- Order Wizard відправляє інформацію про предмет/замовлення до калькулятора
- Калькулятор повертає результат розрахунку з деталізацією
- Order Wizard відображає користувачу детальний розрахунок

### 6.2. Інтеграція з базою даних

- Калькулятор використовує прайс-лист та коефіцієнти з бази даних
- Результати розрахунків зберігаються в базі даних для аудиту та звітності

### 6.3. Взаємодія з Receipt Generator

- Калькулятор передає детальну інформацію про розрахунок до генератора квитанцій
- Генератор квитанцій використовує цю інформацію для формування документа

## 7. Розширюваність та гнучкість

### 7.1. Стратегія для додавання нових правил

- Використання патерну "Стратегія" для інкапсуляції різних алгоритмів розрахунку
- Налаштування через конфігурацію без зміни коду

### 7.2. Версіонування правил розрахунку

- Підтримка версій правил розрахунку для різних періодів
- Можливість перерахунку існуючих замовлень за необхідності

## 8. Приклади використання калькулятора

### 8.1. Розрахунок вартості окремого предмета

```
// Псевдокод виклику
ItemCalculationRequest request = new ItemCalculationRequest();
request.setCategoryId("cleaning_textile");
request.setItemType("jacket");
request.setMaterial("wool");
request.setColor("black");
request.addModifier("manual_cleaning", true);
request.addModifier("heavily_soiled", true);

DetailedItemCalculation result = priceCalculator.calculateItemPrice(request);
```

### 8.2. Розрахунок вартості замовлення

```
// Псевдокод виклику
OrderCalculationRequest request = new OrderCalculationRequest();
request.addItem(item1);
request.addItem(item2);
request.setDiscountType("military");
request.setUrgencyLevel(0.5); // +50%

OrderPriceCalculation result = priceCalculator.calculateOrderPrice(request);
```

## 9. Тестування та перевірка коректності

- Створення детальних тест-кейсів для всіх можливих комбінацій параметрів
- Перевірка граничних випадків та екстремальних значень
- Порівняння з ручними розрахунками для підтвердження коректності

## 10. Рекомендації щодо імплементації

- Використання BigDecimal для уникнення помилок округлення
- Реалізація розрахунків з деталізацією кожного кроку
- Зручний API для інтеграції з іншими компонентами системи
- Кешування часто використовуваних даних для підвищення продуктивності