openapi: 3.0.4
info:
  title: Order API
  description: Order management API for dry cleaning system
  version: 1.0.0
  contact:
    name: API Support
    email: support@dryclean.example.com

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.dryclean.example.com
    description: Production

tags:
  - name: orders
    description: Order management operations

paths:
  /api/orders:
    get:
      operationId: listOrders
      summary: List orders
      description: Get paginated list of orders
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - $ref: "../openapi/common.yaml#/components/parameters/PageNumber"
        - $ref: "../openapi/common.yaml#/components/parameters/PageSize"
        - $ref: "#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
        - name: customerId
          in: query
          description: Filter by customer ID
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter by order status
          required: false
          schema:
            $ref: "../openapi/common.yaml#/components/schemas/OrderStatus"
        - name: branchId
          in: query
          description: Filter by branch ID
          required: false
          schema:
            type: string
            format: uuid
        - name: dateFrom
          in: query
          description: Filter by creation date from
          required: false
          schema:
            type: string
            format: date-time
        - name: dateTo
          in: query
          description: Filter by creation date to
          required: false
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: List of orders
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

    post:
      operationId: createOrder
      summary: Create order from cart
      description: Create a new order from the current cart
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
      responses:
        "201":
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid

    get:
      operationId: getOrderById
      summary: Get order details
      description: Get detailed order information
      tags:
        - orders
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

    patch:
      operationId: updateOrderStatus
      summary: Update order status
      description: Update the status of an order
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateOrderStatusRequest"
      responses:
        "200":
          description: Order updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/items/{itemId}/characteristics:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid
      - name: itemId
        in: path
        required: true
        description: Order item ID
        schema:
          type: string
          format: uuid

    put:
      operationId: updateItemCharacteristics
      summary: Update item characteristics
      description: Update characteristics, stains, and defects of an order item
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateItemCharacteristicsRequest"
      responses:
        "200":
          description: Characteristics updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderItemInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/items/{itemId}/photos:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid
      - name: itemId
        in: path
        required: true
        description: Order item ID
        schema:
          type: string
          format: uuid

    post:
      operationId: uploadItemPhoto
      summary: Upload item photo
      description: Upload a photo for an order item
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              title: UploadItemPhotoRequest
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Photo file (max 5MB)
                photoType:
                  $ref: "../openapi/common.yaml#/components/schemas/PhotoType"
                photoDescription:
                  type: string
                  description: Photo description
      responses:
        "201":
          description: Photo uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ItemPhotoInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"
        "413":
          $ref: "../openapi/common.yaml#/components/responses/PayloadTooLarge"

  /api/orders/{orderId}/items/{itemId}/photos/{photoId}:
    parameters:
      - name: orderId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: photoId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    delete:
      operationId: deleteItemPhoto
      summary: Delete item photo
      description: Delete a photo from an order item
      tags:
        - orders
      security:
        - cookieAuth: []
      responses:
        "204":
          description: Photo deleted successfully
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/receipt:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid

    get:
      operationId: getOrderReceipt
      summary: Get order receipt
      description: Get receipt PDF for an order
      tags:
        - orders
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Receipt PDF
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/signature:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid

    post:
      operationId: saveCustomerSignature
      summary: Save customer signature
      description: Save customer signature for order in base64 format
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SaveSignatureRequest"
      responses:
        "200":
          description: Signature saved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/by-number/{orderNumber}:
    get:
      operationId: getOrderByNumber
      summary: Get order by order number
      description: Get order details by order number
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: orderNumber
          in: path
          required: true
          description: Order number
          schema:
            type: string
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/customer/{customerId}/history:
    get:
      operationId: getCustomerOrderHistory
      summary: Get customer order history
      description: Get paginated order history for a specific customer
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: customerId
          in: path
          required: true
          description: Customer ID
          schema:
            type: string
            format: uuid
        - $ref: "../openapi/common.yaml#/components/parameters/PageNumber"
        - $ref: "../openapi/common.yaml#/components/parameters/PageSize"
        - $ref: "#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
      responses:
        "200":
          description: Customer order history
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/orders/customer/{customerId}/recent:
    get:
      operationId: getCustomerRecentOrders
      summary: Get customer recent orders
      description: Get customer's most recent orders (limited list)
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: customerId
          in: path
          required: true
          description: Customer ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: Maximum number of orders to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        "200":
          description: Recent orders list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OrderInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/orders/due-for-completion:
    get:
      operationId: getOrdersDueForCompletion
      summary: Get orders due for completion
      description: Get orders that are due for completion within specified days
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: days
          in: query
          description: Number of days to look ahead
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 30
            default: 7
        - $ref: "../openapi/common.yaml#/components/parameters/PageNumber"
        - $ref: "../openapi/common.yaml#/components/parameters/PageSize"
        - $ref: "#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
      responses:
        "200":
          description: Orders due for completion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/orders/overdue:
    get:
      operationId: getOverdueOrders
      summary: Get overdue orders
      description: Get orders that are past their expected completion date
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - $ref: "../openapi/common.yaml#/components/parameters/PageNumber"
        - $ref: "../openapi/common.yaml#/components/parameters/PageSize"
        - $ref: "#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
      responses:
        "200":
          description: Overdue orders
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/orders/by-status:
    get:
      operationId: getOrdersByStatus
      summary: Get orders by status
      description: Get all orders with specific status (non-paginated)
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: status
          in: query
          description: Order status
          required: true
          schema:
            $ref: "../openapi/common.yaml#/components/schemas/OrderStatus"
        - name: branchId
          in: query
          description: Filter by branch ID
          required: false
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Orders with specified status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OrderInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/orders/{orderId}/items:
    get:
      operationId: getOrderItems
      summary: Get order items
      description: Get all items for a specific order
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order items list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/OrderItemInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/payments:
    get:
      operationId: getOrderPayments
      summary: Get order payments
      description: Get payment history for a specific order
      tags:
        - orders
      security:
        - cookieAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order payments list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PaymentInfo"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  /api/orders/{orderId}/payment:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Order ID
        schema:
          type: string
          format: uuid

    post:
      operationId: addOrderPayment
      summary: Add payment to order
      description: Register a payment for an order
      tags:
        - orders
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddPaymentRequest"
      responses:
        "201":
          description: Payment registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentInfo"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

components:
  parameters:
    PageNumber:
      $ref: "../openapi/common.yaml#/components/parameters/PageNumber"
    PageSize:
      $ref: "../openapi/common.yaml#/components/parameters/PageSize"

    SortBy:
      name: sortBy
      in: query
      description: Field to sort by
      schema:
        type: string
        default: createdAt
        enum: [createdAt, orderNumber, status, totalAmount]

    SortOrder:
      $ref: "../openapi/common.yaml#/components/parameters/SortOrder"

  schemas:
    OrderInfo:
      type: object
      required:
        - id
        - orderNumber
        - customerId
        - customer
        - branchId
        - status
        - items
        - pricing
        - createdAt
        - expectedCompletionDate
      properties:
        id:
          type: string
          format: uuid
          description: Order ID
        orderNumber:
          type: string
          description: Order number
        customerId:
          type: string
          format: uuid
          description: Customer ID
        customer:
          $ref: "#/components/schemas/CustomerSummary"
        branchId:
          type: string
          format: uuid
          description: Branch ID
        uniqueLabel:
          type: string
          description: Unique label (QR code)
        status:
          $ref: "../openapi/common.yaml#/components/schemas/OrderStatus"
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItemInfo"
        pricing:
          $ref: "#/components/schemas/OrderPricingInfo"
        payments:
          type: array
          items:
            $ref: "#/components/schemas/PaymentInfo"
        notes:
          type: string
          description: Order notes
        customerSignature:
          type: string
          description: Customer signature (base64)
        createdAt:
          type: string
          format: date-time
          description: Creation time
        createdBy:
          type: string
          description: Created by user ID
        expectedCompletionDate:
          type: string
          format: date-time
          description: Expected completion date
        actualCompletionDate:
          type: string
          format: date-time
          description: Actual completion date

    CustomerSummary:
      type: object
      required:
        - id
        - firstName
        - lastName
        - phone
      properties:
        id:
          type: string
          format: uuid
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
        email:
          type: string

    OrderItemInfo:
      type: object
      required:
        - id
        - priceListItemId
        - priceListItem
        - quantity
        - characteristics
        - pricing
      properties:
        id:
          type: string
          format: uuid
          description: Order item ID
        priceListItemId:
          type: string
          format: uuid
          description: Price list item ID
        priceListItem:
          allOf:
            - $ref: "#/components/schemas/PriceListItemSummary"
          description: Price list item details
        quantity:
          type: integer
          description: Quantity (in units)
        characteristics:
          allOf:
            - $ref: "#/components/schemas/ItemCharacteristics"
          description: Item characteristics
        stains:
          type: array
          items:
            $ref: "#/components/schemas/ItemStain"
          description: Item stains
        defects:
          type: array
          items:
            $ref: "#/components/schemas/ItemDefect"
          description: Item defects
        risks:
          type: array
          items:
            $ref: "#/components/schemas/ItemRisk"
          description: Item risks
        photos:
          type: array
          items:
            $ref: "#/components/schemas/ItemPhotoInfo"
          description: Item photos
        modifiers:
          type: array
          items:
            $ref: "#/components/schemas/ItemModifier"
          description: Applied modifiers
        pricing:
          allOf:
            - $ref: "#/components/schemas/OrderItemPricingInfo"
          description: Item pricing details

    PriceListItemSummary:
      type: object
      required:
        - id
        - name
        - categoryCode
        - unitOfMeasure
        - basePrice
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        categoryCode:
          $ref: "../openapi/common.yaml#/components/schemas/ServiceCategoryType"
        unitOfMeasure:
          $ref: "../openapi/common.yaml#/components/schemas/UnitOfMeasure"
        basePrice:
          type: integer
          description: Base price in kopiykas

    ItemCharacteristics:
      type: object
      properties:
        material:
          type: string
          description: Material type
        color:
          type: string
          description: Item color
        filler:
          type: string
          description: Filler type
        fillerCondition:
          allOf:
            - $ref: "../openapi/common.yaml#/components/schemas/FillerCondition"
          description: Filler condition
        wearLevel:
          allOf:
            - $ref: "../openapi/common.yaml#/components/schemas/WearLevel"
          description: Wear level

    ItemStain:
      type: object
      required:
        - type
      properties:
        type:
          $ref: "../openapi/common.yaml#/components/schemas/StainType"
        description:
          type: string
          description: Additional description

    ItemDefect:
      type: object
      required:
        - type
      properties:
        type:
          $ref: "../openapi/common.yaml#/components/schemas/DefectType"
        description:
          type: string
          description: Additional description

    ItemRisk:
      type: object
      required:
        - type
      properties:
        type:
          $ref: "../openapi/common.yaml#/components/schemas/RiskType"
        description:
          type: string
          description: Risk description

    ItemPhotoInfo:
      type: object
      required:
        - id
        - url
        - type
        - uploadedAt
      properties:
        id:
          type: string
          format: uuid
          description: Photo ID
        url:
          type: string
          description: Photo URL
        type:
          $ref: "../openapi/common.yaml#/components/schemas/PhotoType"
        description:
          type: string
          description: Photo description
        uploadedAt:
          type: string
          format: date-time
          description: Upload time
        uploadedBy:
          type: string
          description: Uploaded by user ID

    ItemModifier:
      type: object
      required:
        - code
        - name
        - type
        - value
      properties:
        code:
          type: string
          description: Modifier code
        name:
          type: string
          description: Modifier name
        type:
          $ref: "../openapi/common.yaml#/components/schemas/ModifierType"
        value:
          type: number
          description: Modifier value

    OrderItemPricingInfo:
      type: object
      required:
        - basePrice
        - modifiersTotalAmount
        - subtotal
        - urgencyAmount
        - discountAmount
        - total
      properties:
        basePrice:
          type: integer
          description: Base price in kopiykas
        modifierDetails:
          type: array
          items:
            $ref: "#/components/schemas/ModifierDetail"
          description: Applied modifier details
        modifiersTotalAmount:
          type: integer
          description: Total modifiers amount
        subtotal:
          type: integer
          description: Subtotal (base + modifiers)
        urgencyAmount:
          type: integer
          description: Urgency surcharge
        discountAmount:
          type: integer
          description: Discount amount
        total:
          type: integer
          description: Total price

    ModifierDetail:
      type: object
      required:
        - code
        - name
        - amount
      properties:
        code:
          type: string
        name:
          type: string
        amount:
          type: integer

    OrderPricingInfo:
      type: object
      required:
        - itemsSubtotal
        - urgencyAmount
        - discountAmount
        - total
        - paidAmount
        - balanceDue
      properties:
        itemsSubtotal:
          type: integer
          description: Sum of all items subtotals
        urgencyAmount:
          type: integer
          description: Total urgency amount
        discountAmount:
          type: integer
          description: Total discount amount
        discountApplicableAmount:
          type: integer
          description: Amount eligible for discount
        total:
          type: integer
          description: Final total
        paidAmount:
          type: integer
          description: Total paid amount
        balanceDue:
          type: integer
          description: Balance due

    PaymentInfo:
      type: object
      required:
        - id
        - amount
        - method
        - paidAt
      properties:
        id:
          type: string
          format: uuid
        amount:
          type: integer
          description: Payment amount in kopiykas
        method:
          $ref: "../openapi/common.yaml#/components/schemas/PaymentMethod"
        paidAt:
          type: string
          format: date-time
        paidBy:
          type: string
          description: User ID who registered payment

    CreateOrderRequest:
      type: object
      required:
        - cartId
        - branchId
      properties:
        cartId:
          type: string
          format: uuid
          description: Cart ID to create order from
        branchId:
          type: string
          format: uuid
          description: Branch ID
        uniqueLabel:
          type: string
          description: Unique label (QR code)
        notes:
          type: string
          description: Order notes
        customerSignature:
          type: string
          description: Customer signature (base64)
        termsAccepted:
          type: boolean
          description: Terms and conditions accepted
          default: false

    UpdateOrderStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: "../openapi/common.yaml#/components/schemas/OrderStatus"
        notes:
          type: string
          description: Status change notes

    UpdateItemCharacteristicsRequest:
      type: object
      properties:
        characteristics:
          $ref: "#/components/schemas/ItemCharacteristics"
        stains:
          type: array
          items:
            $ref: "#/components/schemas/ItemStain"
        defects:
          type: array
          items:
            $ref: "#/components/schemas/ItemDefect"
        risks:
          type: array
          items:
            $ref: "#/components/schemas/ItemRisk"

    AddPaymentRequest:
      type: object
      required:
        - amount
        - method
      properties:
        amount:
          type: integer
          minimum: 1
          description: Payment amount in kopiykas
        method:
          $ref: "../openapi/common.yaml#/components/schemas/PaymentMethod"

    SaveSignatureRequest:
      type: object
      required:
        - signature
      properties:
        signature:
          type: string
          description: Customer signature in base64 format
          example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="

    # Pagination schema
    OrderListResponse:
      allOf:
        - $ref: "../openapi/common.yaml#/components/schemas/PaginatedResponse"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/OrderInfo"

  securitySchemes:
    cookieAuth:
      $ref: "../openapi/common.yaml#/components/securitySchemes/cookieAuth"
