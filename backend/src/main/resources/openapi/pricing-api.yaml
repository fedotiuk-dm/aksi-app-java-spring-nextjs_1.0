openapi: 3.0.4
info:
  title: Pricing API
  description: Pricing calculation API for dry cleaning services
  version: 1.0.0
  contact:
    name: API Support
    email: support@dryclean.example.com

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.dryclean.example.com
    description: Production

tags:
  - name: pricing
    description: Pricing calculations

paths:
  /api/pricing/calculate:
    post:
      operationId: calculatePrice
      summary: Calculate price for items
      description: Calculate price for one or more items with modifiers
      tags:
        - pricing
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceCalculationRequest"
      responses:
        "200":
          description: Price calculation result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceCalculationResponse"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/pricing/modifiers:
    get:
      operationId: listPriceModifiers
      summary: List available price modifiers
      description: Get list of all available price modifiers
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: categoryCode
          in: query
          description: Filter by category code
          required: false
          schema:
            $ref: "../openapi/common.yaml#/components/schemas/ServiceCategoryType"
        - $ref: "../openapi/common.yaml#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
        - name: active
          in: query
          description: Filter by active status
          required: false
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: List of price modifiers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceModifiersResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  /api/pricing/discounts:
    get:
      operationId: listDiscounts
      summary: List available discounts
      description: Get list of all available discount types
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: active
          in: query
          description: Filter by active status
          required: false
          schema:
            type: boolean
            default: true
        - $ref: "../openapi/common.yaml#/components/parameters/SortBy"
        - $ref: "../openapi/common.yaml#/components/parameters/SortOrder"
      responses:
        "200":
          description: List of discounts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DiscountsResponse"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"

  # Admin endpoints for price modifiers
  /api/pricing/admin/modifiers:
    post:
      operationId: createPriceModifier
      summary: Create a new price modifier
      description: Create a new price modifier (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceModifier"
      responses:
        "201":
          description: Price modifier created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceModifier"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"

  /api/pricing/admin/modifiers/{code}:
    put:
      operationId: updatePriceModifier
      summary: Update price modifier
      description: Update an existing price modifier (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: code
          in: path
          description: Price modifier code
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceModifier"
      responses:
        "200":
          description: Price modifier updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceModifier"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

    delete:
      operationId: deletePriceModifier
      summary: Delete price modifier
      description: Delete a price modifier (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: code
          in: path
          description: Price modifier code
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Price modifier deleted
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

  # Admin endpoints for discounts
  /api/pricing/admin/discounts:
    post:
      operationId: createDiscount
      summary: Create a new discount
      description: Create a new discount (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Discount"
      responses:
        "201":
          description: Discount created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Discount"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"

  /api/pricing/admin/discounts/{code}:
    put:
      operationId: updateDiscount
      summary: Update discount
      description: Update an existing discount (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: code
          in: path
          description: Discount code
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Discount"
      responses:
        "200":
          description: Discount updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Discount"
        "400":
          $ref: "../openapi/common.yaml#/components/responses/BadRequest"
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

    delete:
      operationId: deleteDiscount
      summary: Delete discount
      description: Delete a discount (admin only)
      tags:
        - pricing
      security:
        - cookieAuth: []
      parameters:
        - name: code
          in: path
          description: Discount code
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Discount deleted
        "401":
          $ref: "../openapi/common.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "../openapi/common.yaml#/components/responses/Forbidden"
        "404":
          $ref: "../openapi/common.yaml#/components/responses/NotFound"

components:
  schemas:
    PriceCalculationRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/PriceCalculationItem"
          description: Items to calculate price for
        globalModifiers:
          $ref: "#/components/schemas/GlobalPriceModifiers"

    PriceCalculationItem:
      type: object
      required:
        - priceListItemId
        - quantity
      properties:
        priceListItemId:
          type: string
          format: uuid
          description: Price list item ID
        quantity:
          type: integer
          minimum: 1
          description: Quantity (in units)
        characteristics:
          $ref: "#/components/schemas/ItemCharacteristics"
        modifierCodes:
          type: array
          items:
            type: string
          description: Modifier codes to apply

    ItemCharacteristics:
      type: object
      properties:
        material:
          type: string
          description: Material type
        color:
          type: string
          description: Item color (affects dyeing price)
        wearLevel:
          $ref: "../openapi/common.yaml#/components/schemas/WearLevel"

    GlobalPriceModifiers:
      type: object
      x-discount-excluded-categories: [LAUNDRY, IRONING, DYEING]
      x-discount-excluded-categories-description: |
        Categories excluded from all discounts:
        * `LAUNDRY` - Прання (Laundry)
        * `IRONING` - Прасування (Ironing)
        * `DYEING` - Фарбування (Dyeing)
      properties:
        urgencyType:
          allOf:
            - $ref: "../openapi/common.yaml#/components/schemas/UrgencyType"
            - x-enum-varnames: [NORMAL, EXPRESS_48H, EXPRESS_24H]
              x-enum-descriptions:
                - Standard processing
                - Express 48 hours
                - Express 24 hours
              x-enum-percentages:
                - 0
                - 50
                - 100
              default: NORMAL
              description: |
                Urgency type:
                * `NORMAL` - Standard processing (0%)
                * `EXPRESS_48H` - Express 48 hours (+50%)
                * `EXPRESS_24H` - Express 24 hours (+100%)
        discountType:
          allOf:
            - $ref: "../openapi/common.yaml#/components/schemas/DiscountType"
            - x-enum-varnames: [NONE, EVERCARD, SOCIAL_MEDIA, MILITARY, OTHER]
              x-enum-descriptions:
                - No discount
                - Evercard discount
                - Social media discount
                - Military discount
                - Other discount
              x-enum-percentages:
                - 0
                - 10
                - 5
                - 10
                - null
              default: NONE
              description: |
                Discount type:
                * `NONE` - No discount (0%)
                * `EVERCARD` - Evercard discount (10%)
                * `SOCIAL_MEDIA` - Social media discount (5%)
                * `MILITARY` - Military discount (10%)
                * `OTHER` - Other discount (requires discountPercentage)
        discountPercentage:
          type: integer
          minimum: 0
          maximum: 100
          description: Discount percentage (required for OTHER type)

    PriceCalculationResponse:
      type: object
      required:
        - items
        - totals
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/CalculatedItemPrice"
          description: Calculated prices for each item
        totals:
          $ref: "#/components/schemas/CalculationTotals"
        warnings:
          type: array
          items:
            type: string
          description: Calculation warnings (e.g., discount not applicable)

    CalculatedItemPrice:
      type: object
      required:
        - priceListItemId
        - itemName
        - quantity
        - basePrice
        - calculations
        - total
      properties:
        priceListItemId:
          type: string
          format: uuid
        itemName:
          type: string
          description: Item name from price list
        categoryCode:
          $ref: "../openapi/common.yaml#/components/schemas/ServiceCategoryType"
        quantity:
          type: integer
        basePrice:
          type: integer
          description: Base price per unit in kopiykas
        calculations:
          $ref: "#/components/schemas/ItemPriceCalculation"
        total:
          type: integer
          description: Total price for this item in kopiykas

    ItemPriceCalculation:
      type: object
      required:
        - baseAmount
        - modifiers
        - subtotal
        - urgencyModifier
        - discountModifier
        - finalAmount
      properties:
        baseAmount:
          type: integer
          description: Base amount (base price × quantity) in kopiykas
        modifiers:
          type: array
          items:
            $ref: "#/components/schemas/AppliedModifier"
          description: Applied modifiers with amounts
        modifiersTotal:
          type: integer
          description: Total modifiers amount in kopiykas
        subtotal:
          type: integer
          description: Subtotal (base + modifiers) in kopiykas
        urgencyModifier:
          $ref: "#/components/schemas/AppliedModifier"
        discountModifier:
          $ref: "#/components/schemas/AppliedModifier"
        discountEligible:
          type: boolean
          description: Whether item is eligible for discount
        finalAmount:
          type: integer
          description: Final amount after all calculations in kopiykas

    AppliedModifier:
      type: object
      required:
        - code
        - name
        - type
        - value
        - amount
      properties:
        code:
          type: string
          description: Modifier code
        name:
          type: string
          description: Modifier name
        type:
          $ref: "../openapi/common.yaml#/components/schemas/ModifierType"
        value:
          type: integer
          description: Modifier value (percentage in basis points *100 or fixed amount in kopiykas)
        amount:
          type: integer
          description: Calculated amount in kopiykas

    CalculationTotals:
      type: object
      required:
        - itemsSubtotal
        - urgencyAmount
        - discountAmount
        - discountApplicableAmount
        - total
      properties:
        itemsSubtotal:
          type: integer
          description: Sum of all items subtotals in kopiykas
        urgencyAmount:
          type: integer
          description: Total urgency surcharge in kopiykas
        urgencyPercentage:
          type: integer
          description: Applied urgency percentage
        discountAmount:
          type: integer
          description: Total discount amount in kopiykas
        discountPercentage:
          type: integer
          description: Applied discount percentage
        discountApplicableAmount:
          type: integer
          description: Amount eligible for discount in kopiykas
        total:
          type: integer
          description: Final total amount in kopiykas
        expectedCompletionDate:
          type: string
          format: date-time
          description: Expected completion date based on items and urgency
        expectedCompletionNote:
          type: string
          description: Optional note (e.g., "після 14:00")

    PriceModifier:
      type: object
      required:
        - code
        - name
        - type
        - value
        - active
      properties:
        code:
          type: string
          description: Unique modifier code
          x-unique: true
        name:
          type: string
          description: Modifier name
        description:
          type: string
          description: Modifier description
        type:
          $ref: "../openapi/common.yaml#/components/schemas/ModifierType"
        value:
          type: integer
          description: |
            Modifier value:
            - For PERCENTAGE: basis points (e.g., 1550 = 15.5%)
            - For FIXED: amount in kopiykas per item
        categoryRestrictions:
          type: array
          items:
            $ref: "../openapi/common.yaml#/components/schemas/ServiceCategoryType"
          description: Category codes where modifier is applicable
        active:
          type: boolean
          description: Is modifier active
        sortOrder:
          type: integer
          description: Sort order for display
          default: 0

    PriceModifierInfo:
      allOf:
        - $ref: "#/components/schemas/PriceModifier"
        - type: object
          properties:
            id:
              type: string
              format: uuid
              description: Modifier ID
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            updatedAt:
              type: string
              format: date-time
              description: Last update timestamp

    Discount:
      type: object
      required:
        - code
        - name
        - percentage
        - active
      properties:
        code:
          type: string
          description: Unique discount code
          x-unique: true
        name:
          type: string
          description: Discount name
        description:
          type: string
          description: Discount description
        percentage:
          type: integer
          minimum: 0
          maximum: 100
          description: Discount percentage
        excludedCategories:
          type: array
          items:
            $ref: "../openapi/common.yaml#/components/schemas/ServiceCategoryType"
          description: Category codes excluded from discount
        active:
          type: boolean
          description: Is discount active
        sortOrder:
          type: integer
          description: Sort order for display
          default: 0

    DiscountInfo:
      allOf:
        - $ref: "#/components/schemas/Discount"
        - type: object
          properties:
            id:
              type: string
              format: uuid
              description: Discount ID
            createdAt:
              type: string
              format: date-time
              description: Creation timestamp
            updatedAt:
              type: string
              format: date-time
              description: Last update timestamp

    PriceModifiersResponse:
      type: object
      required:
        - modifiers
      properties:
        modifiers:
          type: array
          items:
            $ref: "#/components/schemas/PriceModifier"
          description: List of price modifiers
        generalModifiers:
          type: array
          items:
            $ref: "#/components/schemas/PriceModifier"
          description: General modifiers (applicable to all categories)
        textileModifiers:
          type: array
          items:
            $ref: "#/components/schemas/PriceModifier"
          description: Textile-specific modifiers
        leatherModifiers:
          type: array
          items:
            $ref: "#/components/schemas/PriceModifier"
          description: Leather-specific modifiers

    DiscountsResponse:
      type: object
      required:
        - discounts
      properties:
        discounts:
          type: array
          items:
            $ref: "#/components/schemas/Discount"
          description: List of available discounts

    # ErrorResponse removed; use common.yaml

  securitySchemes:
    cookieAuth:
      $ref: "../openapi/common.yaml#/components/securitySchemes/cookieAuth"
