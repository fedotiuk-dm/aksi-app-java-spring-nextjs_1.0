databaseChangeLog:
  - changeSet:
      id: create-game-modifiers-table
      author: system
      comment: Create game_modifiers table for game boosting modifiers
      runOnChange: false

      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: game_modifiers

      changes:
        - createTable:
            tableName: game_modifiers
            columns:
              - column:
                  name: id
                  type: uuid
                  defaultValueComputed: gen_random_uuid()
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: version
                  type: bigint
                  defaultValue: "0"
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
                  defaultValueComputed: current_timestamp
                  constraints:
                    nullable: false
              - column:
                  name: code
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: text
              - column:
                  name: modifier_type
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: operation_type
                  type: varchar(20)
                  defaultValue: ADD
                  constraints:
                    nullable: false
              - column:
                  name: modifier_value
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: game_code
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: sort_order
                  type: integer
                  defaultValue: "0"
              - column:
                  name: icon
                  type: varchar(10)
              - column:
                  name: color
                  type: varchar(7)
              - column:
                  name: priority
                  type: integer
                  defaultValue: "0"
              - column:
                  name: max_uses
                  type: integer
              - column:
                  name: effective_date
                  type: timestamp
              - column:
                  name: expiration_date
                  type: timestamp
              - column:
                  name: conditions
                  type: text
              - column:
                  name: active
                  type: boolean
                  defaultValue: "true"
                  constraints:
                    nullable: false

        - createTable:
            tableName: game_modifier_service_types
            columns:
              - column:
                  name: game_modifier_id
                  type: uuid
                  constraints:
                    nullable: false
                    foreignKeyName: fk_game_modifier_service_types_modifier
                    referencedTableName: game_modifiers
                    referencedColumnNames: id
              - column:
                  name: service_type_code
                  type: varchar(50)
                  constraints:
                    nullable: false

        - addUniqueConstraint:
            tableName: game_modifiers
            columnNames: code, game_code
            constraintName: uk_game_modifier_code_game

        - createIndex:
            tableName: game_modifiers
            indexName: idx_game_modifier_code
            columns:
              - column:
                  name: code

        - createIndex:
            tableName: game_modifiers
            indexName: idx_game_modifier_game_code
            columns:
              - column:
                  name: game_code

        - createIndex:
            tableName: game_modifiers
            indexName: idx_game_modifier_type
            columns:
              - column:
                  name: modifier_type

        - createIndex:
            tableName: game_modifiers
            indexName: idx_game_modifier_active
            columns:
              - column:
                  name: active

        - createIndex:
            tableName: game_modifiers
            indexName: idx_game_modifier_sort_order
            columns:
              - column:
                  name: sort_order

  - changeSet:
      id: create-game-modifiers-foreign-key
      author: system
      comment: Create foreign key constraint for game modifier service types
      runOnChange: false

      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: game_modifier_service_types
            - tableExists:
                tableName: game_modifiers
        - not:
            - foreignKeyConstraintExists:
                foreignKeyTableName: game_modifier_service_types
                foreignKeyName: fk_game_modifier_service_types_modifier

      changes:
        - addForeignKeyConstraint:
            baseTableName: game_modifier_service_types
            baseColumnNames: game_modifier_id
            referencedTableName: game_modifiers
            referencedColumnNames: id
            constraintName: fk_game_modifier_service_types_modifier

  - changeSet:
      id: insert-sample-game-modifiers
      author: system
      comment: Insert sample game modifiers data
      runOnChange: false

      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: game_modifiers
        - not:
            - sqlCheck:
                expectedResult: 1
                sql: SELECT COUNT(*) FROM game_modifiers WHERE code = 'RUSH_24H'

      changes:
        - insert:
            tableName: game_modifiers
            columns:
              - column:
                  name: code
                  value: RUSH_24H
              - column:
                  name: name
                  value: 24 Hour Rush
              - column:
                  name: description
                  value: Complete the boost within 24 hours
              - column:
                  name: modifier_type
                  value: TIMING
              - column:
                  name: operation_type
                  value: MULTIPLY
              - column:
                  name: modifier_value
                  value: "150"
              - column:
                  name: game_code
                  value: WOW
              - column:
                  name: sort_order
                  value: "1"
              - column:
                  name: icon
                  value: LIGHTNING
              - column:
                  name: color
                  value: "#FF6B35"
              - column:
                  name: active
                  value: "true"

        - insert:
            tableName: game_modifier_service_types
            columns:
              - column:
                  name: game_modifier_id
                  valueComputed: (SELECT id FROM game_modifiers WHERE code = 'RUSH_24H' LIMIT 1)
              - column:
                  name: service_type_code
                  value: LEVEL_BOOST

        - insert:
            tableName: game_modifiers
            columns:
              - column:
                  name: code
                  value: PREMIUM_SERVICE
              - column:
                  name: name
                  value: Premium Service
              - column:
                  name: description
                  value: High-quality service with experienced boosters
              - column:
                  name: modifier_type
                  value: QUALITY
              - column:
                  name: operation_type
                  value: MULTIPLY
              - column:
                  name: modifier_value
                  value: "125"
              - column:
                  name: game_code
                  value: WOW
              - column:
                  name: sort_order
                  value: "2"
              - column:
                  name: icon
                  value: CROWN
              - column:
                  name: color
                  value: "#FFD700"
              - column:
                  name: active
                  value: "true"

        - insert:
            tableName: game_modifier_service_types
            columns:
              - column:
                  name: game_modifier_id
                  valueComputed: (SELECT id FROM game_modifiers WHERE code = 'PREMIUM_SERVICE' LIMIT 1)
              - column:
                  name: service_type_code
                  value: LEVEL_BOOST

        - insert:
            tableName: game_modifiers
            columns:
              - column:
                  name: code
                  value: VOICE_CHAT
              - column:
                  name: name
                  value: Voice Chat Support
              - column:
                  name: description
                  value: Real-time voice communication during boost
              - column:
                  name: modifier_type
                  value: SUPPORT
              - column:
                  name: operation_type
                  value: ADD
              - column:
                  name: modifier_value
                  value: "5000"
              - column:
                  name: game_code
                  value: WOW
              - column:
                  name: sort_order
                  value: "3"
              - column:
                  name: icon
                  value: MICROPHONE
              - column:
                  name: color
                  value: "#4CAF50"
              - column:
                  name: active
                  value: "true"

        - insert:
            tableName: game_modifier_service_types
            columns:
              - column:
                  name: game_modifier_id
                  valueComputed: (SELECT id FROM game_modifiers WHERE code = 'VOICE_CHAT' LIMIT 1)
              - column:
                  name: service_type_code
                  value: LEVEL_BOOST
