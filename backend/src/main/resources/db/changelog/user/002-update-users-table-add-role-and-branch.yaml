databaseChangeLog:
  - changeSet:
      id: user-002-fix-active-column-migration
      author: system
      comment: Remove old active column and update role constraint to include MANAGER
      preConditions:
        - onFail: MARK_RAN
        - columnExists:
            tableName: users
            columnName: active
      changes:
        # First drop the index on active column if exists
        - dropIndex:
            tableName: users
            indexName: idx_users_active
        # Drop old active column (is_active already exists from migration 001)
        - dropColumn:
            tableName: users
            columnName: active
                  
  - changeSet:
      id: user-002-update-users-role-check
      author: system
      comment: Update check constraint for user role to include MANAGER
      changes:
        # First drop the existing constraint from migration 001
        - sql:
            sql: ALTER TABLE users DROP CONSTRAINT IF EXISTS chk_user_role_domain;
        # Add new constraint with MANAGER role
        - sql:
            sql: ALTER TABLE users ADD CONSTRAINT chk_users_role CHECK (role IN ('OPERATOR', 'MANAGER', 'ADMIN'));
            
  - changeSet:
      id: user-002-create-is-active-index
      author: system
      comment: Create index on is_active column
      changes:
        - createIndex:
            tableName: users
            indexName: idx_users_is_active
            columns:
              - column:
                  name: is_active