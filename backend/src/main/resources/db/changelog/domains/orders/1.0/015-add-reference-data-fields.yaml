databaseChangeLog:
  - changeSet:
      id: orders-1.0-015
      author: system
      comment: Add reference data fields to order_items table
      changes:
        # Додання зв'язків з довідковими таблицями
        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: item_color_id
                  type: uuid
                  constraints:
                    nullable: true
                    foreignKeyName: fk_order_items_color
                    references: item_colors(id)
                  remarks: "Зв'язок з таблицею кольорів предметів"

        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: item_material_id
                  type: uuid
                  constraints:
                    nullable: true
                    foreignKeyName: fk_order_items_material
                    references: item_materials(id)
                  remarks: "Зв'язок з таблицею матеріалів предметів"

        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: clothing_size_id
                  type: uuid
                  constraints:
                    nullable: true
                    foreignKeyName: fk_order_items_size
                    references: clothing_sizes(id)
                  remarks: "Зв'язок з таблицею розмірів одягу"

        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: item_condition_id
                  type: uuid
                  constraints:
                    nullable: true
                    foreignKeyName: fk_order_items_condition
                    references: item_conditions(id)
                  remarks: "Зв'язок з таблицею станів предметів"

        # Додання текстових полів для випадків, коли потрібно вказати кастомні значення
        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: custom_color
                  type: varchar(100)
                  constraints:
                    nullable: true
                  remarks: 'Кастомний колір, якщо його немає в довіднику'

        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: custom_material
                  type: varchar(100)
                  constraints:
                    nullable: true
                  remarks: 'Кастомний матеріал, якщо його немає в довіднику'

        - addColumn:
            tableName: order_items
            columns:
              - column:
                  name: custom_size
                  type: varchar(20)
                  constraints:
                    nullable: true
                  remarks: 'Кастомний розмір, якщо його немає в довіднику'

        # Додання індексів для оптимізації запитів
        - createIndex:
            indexName: idx_order_items_color
            tableName: order_items
            columns:
              - column:
                  name: item_color_id

        - createIndex:
            indexName: idx_order_items_material
            tableName: order_items
            columns:
              - column:
                  name: item_material_id

        - createIndex:
            indexName: idx_order_items_size
            tableName: order_items
            columns:
              - column:
                  name: clothing_size_id

        - createIndex:
            indexName: idx_order_items_condition
            tableName: order_items
            columns:
              - column:
                  name: item_condition_id

  - changeSet:
      id: orders-1.0-015-part2
      author: system
      comment: Add constraints and validation triggers
      changes:
        # Додання констрейнту для перевірки, що вказано або ID з довідника, або кастомне значення
        - sql:
            comment: Add check constraint for color - either reference ID or custom text
            sql: |
              ALTER TABLE order_items
              ADD CONSTRAINT chk_order_items_color
              CHECK (
                (item_color_id IS NOT NULL AND custom_color IS NULL) OR
                (item_color_id IS NULL AND custom_color IS NOT NULL) OR
                (item_color_id IS NULL AND custom_color IS NULL)
              );

        - sql:
            comment: Add check constraint for material - either reference ID or custom text
            sql: |
              ALTER TABLE order_items
              ADD CONSTRAINT chk_order_items_material
              CHECK (
                (item_material_id IS NOT NULL AND custom_material IS NULL) OR
                (item_material_id IS NULL AND custom_material IS NOT NULL) OR
                (item_material_id IS NULL AND custom_material IS NULL)
              );

        - sql:
            comment: Add check constraint for size - either reference ID or custom text
            sql: |
              ALTER TABLE order_items
              ADD CONSTRAINT chk_order_items_size
              CHECK (
                (clothing_size_id IS NOT NULL AND custom_size IS NULL) OR
                (clothing_size_id IS NULL AND custom_size IS NOT NULL) OR
                (clothing_size_id IS NULL AND custom_size IS NULL)
              );
