databaseChangeLog:
  - changeSet:
      id: 011-add-discount-restrictions
      author: system
      comment: Add discount restrictions for certain categories according to business rules
      changes:
        # Add discount_allowed field to service_categories table
        - addColumn:
            tableName: service_categories
            columns:
              - column:
                  name: discount_allowed
                  type: boolean
                  defaultValue: "true"
                  constraints:
                    nullable: false
                  remarks: "Indicates if discounts can be applied to this category"
        
        # Update categories where discounts are NOT allowed
        - update:
            tableName: service_categories
            columns:
              - column:
                  name: discount_allowed
                  value: "false"
            where: code IN ('IRONING', 'LAUNDRY', 'DYEING')
        
        # Add exclude_from_discounts field to price_modifiers
        - addColumn:
            tableName: price_modifiers
            columns:
              - column:
                  name: exclude_from_discounts
                  type: boolean
                  defaultValue: "false"
                  constraints:
                    nullable: false
                  remarks: "If true, this modifier will be excluded from discount calculations"
        
        # Mark certain modifiers as non-discountable
        - update:
            tableName: price_modifiers
            columns:
              - column:
                  name: exclude_from_discounts
                  value: "true"
            where: code IN ('URGENT_48H', 'URGENT_24H')
        
      rollback:
        - dropColumn:
            tableName: price_modifiers
            columnName: exclude_from_discounts
        - dropColumn:
            tableName: service_categories
            columnName: discount_allowed