databaseChangeLog:
  - changeSet:
      id: 017-create-order-item-stains-table
      author: system
      comment: "Створює таблицю для зберігання плям предметів замовлення (@ElementCollection)"
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: order_item_stains
      changes:
        - createTable:
            tableName: order_item_stains
            remarks: "Таблиця для зберігання типів плям для кожного предмета замовлення"
            columns:
              - column:
                  name: order_item_id
                  type: UUID
                  constraints:
                    nullable: false
                  remarks: "Зовнішній ключ до таблиці order_items"
              - column:
                  name: stain_type
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                  remarks: "Тип плями (enum StainType)"

        # Foreign key constraint буде додано пізніше після створення order_items таблиці

        - createIndex:
            indexName: idx_order_item_stains_item_id
            tableName: order_item_stains
            columns:
              - column:
                  name: order_item_id

        - createIndex:
            indexName: idx_order_item_stains_type
            tableName: order_item_stains
            columns:
              - column:
                  name: stain_type

        - sql:
            sql: "ALTER TABLE order_item_stains ADD CONSTRAINT chk_stain_type_valid CHECK (stain_type IN ('GREASE', 'BLOOD', 'PROTEIN', 'WINE', 'COFFEE', 'GRASS', 'INK', 'COSMETICS', 'PAINT', 'TAR', 'RUST', 'YELLOWING', 'SWEAT', 'UNKNOWN', 'OTHER'))"

  - changeSet:
      id: 017-create-order-item-defects-table
      author: system
      comment: "Створює таблицю для зберігання дефектів предметів замовлення (@ElementCollection)"
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: order_item_defects
      changes:
        - createTable:
            tableName: order_item_defects
            remarks: "Таблиця для зберігання типів дефектів для кожного предмета замовлення"
            columns:
              - column:
                  name: order_item_id
                  type: UUID
                  constraints:
                    nullable: false
                  remarks: "Зовнішній ключ до таблиці order_items"
              - column:
                  name: defect_type
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                  remarks: "Тип дефекту (enum DefectType)"

        # Foreign key constraint буде додано пізніше після створення order_items таблиці

        - createIndex:
            indexName: idx_order_item_defects_item_id
            tableName: order_item_defects
            columns:
              - column:
                  name: order_item_id

        - createIndex:
            indexName: idx_order_item_defects_type
            tableName: order_item_defects
            columns:
              - column:
                  name: defect_type

        - sql:
            sql: "ALTER TABLE order_item_defects ADD CONSTRAINT chk_defect_type_valid CHECK (defect_type IN ('ABRASION', 'TEAR', 'HOLE', 'MISSING_HARDWARE', 'DAMAGED_HARDWARE', 'COLOR_BLEEDING', 'SHRINKAGE', 'DEFORMATION', 'BUTTON_DAMAGE', 'ZIPPER_DAMAGE', 'LINING_DAMAGE', 'SEAM_DAMAGE', 'FABRIC_THINNING', 'PILLING', 'FADING', 'STIFFNESS', 'ODOR', 'MOLD', 'MOTH_DAMAGE', 'BURN', 'CHEMICAL_DAMAGE', 'WATER_DAMAGE', 'SUN_DAMAGE', 'WEAR_MARKS', 'STRETCHING', 'UNKNOWN', 'OTHER'))"

  - changeSet:
      id: 017-create-order-item-modifiers-table
      author: system
      comment: "Створює таблицю для зберігання модифікаторів предметів замовлення (@ElementCollection)"
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: order_item_modifiers
      changes:
        - createTable:
            tableName: order_item_modifiers
            remarks: "Таблиця для зберігання модифікаторів для кожного предмета замовлення"
            columns:
              - column:
                  name: order_item_id
                  type: UUID
                  constraints:
                    nullable: false
                  remarks: "Зовнішній ключ до таблиці order_items"
              - column:
                  name: modifier_name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
                  remarks: "Назва модифікатора"
              - column:
                  name: modifier_type
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
                  remarks: "Тип модифікатора (enum ModifierType)"
              - column:
                  name: modifier_value
                  type: DECIMAL(10,4)
                  constraints:
                    nullable: false
                  remarks: "Значення модифікатора (відсоток або фіксована сума)"
              - column:
                  name: calculated_amount
                  type: DECIMAL(10,2)
                  constraints:
                    nullable: false
                  remarks: "Розрахована сума модифікатора"
              - column:
                  name: modifier_description
                  type: VARCHAR(200)
                  remarks: "Опис модифікатора"

        # Foreign key constraint буде додано пізніше після створення order_items таблиці

        - createIndex:
            indexName: idx_order_item_modifiers_item_id
            tableName: order_item_modifiers
            columns:
              - column:
                  name: order_item_id

        - createIndex:
            indexName: idx_order_item_modifiers_type
            tableName: order_item_modifiers
            columns:
              - column:
                  name: modifier_type

        - sql:
            sql: "ALTER TABLE order_item_modifiers ADD CONSTRAINT chk_modifier_type_valid CHECK (modifier_type IN ('PERCENTAGE', 'FIXED_AMOUNT'))"

  - changeSet:
      id: 017-create-order-item-photos-table
      author: system
      comment: "Створює таблицю для зберігання URL фотографій предметів замовлення (@ElementCollection)"
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: order_item_photos
      changes:
        - createTable:
            tableName: order_item_photos
            remarks: "Таблиця для зберігання URL фотографій для кожного предмета замовлення"
            columns:
              - column:
                  name: order_item_id
                  type: UUID
                  constraints:
                    nullable: false
                  remarks: "Зовнішній ключ до таблиці order_items"
              - column:
                  name: photo_url
                  type: VARCHAR(500)
                  constraints:
                    nullable: false
                  remarks: "URL фотографії предмета"

        - createIndex:
            tableName: order_item_photos
            indexName: idx_order_item_photos_order_item
            columns:
              - column:
                  name: order_item_id

        # Foreign key constraint буде додано пізніше після створення order_items таблиці

  - changeSet:
      id: 017-add-indexes-performance
      author: system
      comment: "Додає додаткові індекси для оптимізації продуктивності"
      changes:
        - createIndex:
            indexName: idx_order_item_stains_composite
            tableName: order_item_stains
            columns:
              - column:
                  name: order_item_id
              - column:
                  name: stain_type

        - createIndex:
            indexName: idx_order_item_defects_composite
            tableName: order_item_defects
            columns:
              - column:
                  name: order_item_id
              - column:
                  name: defect_type

        - createIndex:
            indexName: idx_order_item_modifiers_composite
            tableName: order_item_modifiers
            columns:
              - column:
                  name: order_item_id
              - column:
                  name: modifier_type

        - createIndex:
            indexName: idx_order_item_photos_composite
            tableName: order_item_photos
            columns:
              - column:
                  name: order_item_id

  - changeSet:
      id: 017-add-order-item-foreign-keys
      author: system
      comment: "Додаємо foreign key constraints для всіх @ElementCollection таблиць після створення order_items таблиці"
      changes:
        - addForeignKeyConstraint:
            baseTableName: order_item_stains
            baseColumnNames: order_item_id
            constraintName: fk_order_item_stains_order_item
            referencedTableName: order_items
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: order_item_defects
            baseColumnNames: order_item_id
            constraintName: fk_order_item_defects_order_item
            referencedTableName: order_items
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: order_item_photos
            baseColumnNames: order_item_id
            constraintName: fk_order_item_photos_order_item
            referencedTableName: order_items
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: order_item_modifiers
            baseColumnNames: order_item_id
            constraintName: fk_order_item_modifiers_order_item
            referencedTableName: order_items
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: RESTRICT
