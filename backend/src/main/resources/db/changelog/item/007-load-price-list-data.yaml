databaseChangeLog:
  - changeSet:
      id: item-007-load-price-list-data
      author: system
      comment: Load initial price list data from CSV file
      preConditions:
        - onFail: MARK_RAN
          tableExists:
            tableName: price_list_items
      changes:
        # First, create a temporary table for CSV data
        - createTable:
            tableName: temp_price_list_csv
            columns:
              - column:
                  name: category_code
                  type: VARCHAR(50)
              - column:
                  name: catalog_number
                  type: INTEGER
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: unit_of_measure_csv
                  type: VARCHAR(50)
              - column:
                  name: base_price
                  type: DECIMAL(10,2)
              - column:
                  name: price_black
                  type: DECIMAL(10,2)
              - column:
                  name: price_color
                  type: DECIMAL(10,2)
              - column:
                  name: active
                  type: BOOLEAN
        
        # Load data from CSV file into temporary table
        - loadData:
            tableName: temp_price_list_csv
            file: db/changelog/item/pricelist/price_list.csv
            encoding: UTF-8
            separator: ","
            quotchar: '"'
            columns:
              - column:
                  name: category_code
                  type: STRING
                  header: category_code
              - column:
                  name: catalog_number
                  type: NUMERIC
                  header: catalog_number
              - column:
                  name: name
                  type: STRING
                  header: name
              - column:
                  name: unit_of_measure_csv
                  type: STRING
                  header: unit_of_measure
              - column:
                  name: base_price
                  type: NUMERIC
                  header: base_price
              - column:
                  name: price_black
                  type: NUMERIC
                  header: price_black
              - column:
                  name: price_color
                  type: NUMERIC
                  header: price_color
              - column:
                  name: active
                  type: BOOLEAN
                  header: active
        
        # Insert data from temporary table with unit conversion
        - sql:
            sql: >
              INSERT INTO price_list_items (
                category_code, catalog_number, name, unit_of_measure, 
                base_price, price_black, price_color, active,
                created_at
              )
              SELECT 
                t.category_code,
                t.catalog_number,
                t.name,
                CASE 
                  WHEN t.unit_of_measure_csv = 'шт' THEN 'PIECE'
                  WHEN t.unit_of_measure_csv = 'кг' THEN 'KILOGRAM'
                  WHEN t.unit_of_measure_csv = 'кв.м' THEN 'SQUARE_METER'
                  WHEN t.unit_of_measure_csv = 'пара' THEN 'PAIR'
                  ELSE 'PIECE'  -- Default to PIECE for any unknown units
                END as unit_of_measure,
                t.base_price,
                t.price_black,
                t.price_color,
                t.active,
                now()
              FROM temp_price_list_csv t
              WHERE t.unit_of_measure_csv IN ('шт', 'кг', 'кв.м', 'пара')
              ON CONFLICT (category_code, catalog_number) DO NOTHING;
        
        # Drop temporary table
        - dropTable:
            tableName: temp_price_list_csv
            
      rollback:
        - delete:
            tableName: price_list_items
            where: catalog_number IS NOT NULL