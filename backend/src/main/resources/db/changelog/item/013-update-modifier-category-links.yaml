databaseChangeLog:
  - changeSet:
      id: 013-update-modifier-category-links
      author: system
      comment: Update modifier-category links to match OrderWizard requirements
      changes:
        # Link STAIN_REMOVAL_DYNAMIC to all textile categories
        - sql:
            sql: |
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code 
              FROM price_modifiers m, service_categories c
              WHERE m.code = 'STAIN_REMOVAL_DYNAMIC'
              AND c.code IN ('CLOTHING', 'HOUSEHOLD', 'CARPETS', 'WET_CLEANING')
              AND NOT EXISTS (
                SELECT 1 FROM modifier_applicable_categories mac 
                WHERE mac.modifier_id = m.id AND mac.category_code = c.code
              );
        
        # Link BUTTON_SEWING_DYNAMIC only to clothing
        - sql:
            sql: |
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, 'CLOTHING'
              FROM price_modifiers m
              WHERE m.code = 'BUTTON_SEWING_DYNAMIC'
              AND NOT EXISTS (
                SELECT 1 FROM modifier_applicable_categories mac 
                WHERE mac.modifier_id = m.id AND mac.category_code = 'CLOTHING'
              );
        
        # Ensure discount modifiers are linked to ALL categories (they will be filtered by discount_allowed flag)
        - sql:
            sql: |
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code 
              FROM price_modifiers m, service_categories c
              WHERE m.code IN ('EVERCARD_DISCOUNT', 'SOCIAL_MEDIA_DISCOUNT', 'MILITARY_DISCOUNT')
              AND c.active = true
              AND NOT EXISTS (
                SELECT 1 FROM modifier_applicable_categories mac 
                WHERE mac.modifier_id = m.id AND mac.category_code = c.code
              );
        
        # Link fur collar/cuffs modifier to appropriate categories
        - sql:
            sql: |
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code 
              FROM price_modifiers m, service_categories c
              WHERE m.code = 'FUR_COLLAR_CUFFS'
              AND c.code IN ('CLOTHING', 'LEATHER', 'PADDING')
              AND NOT EXISTS (
                SELECT 1 FROM modifier_applicable_categories mac 
                WHERE mac.modifier_id = m.id AND mac.category_code = c.code
              );
        
        # Link urgency modifiers to all active categories
        - sql:
            sql: |
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code 
              FROM price_modifiers m, service_categories c
              WHERE m.code IN ('URGENT_48H', 'URGENT_24H')
              AND c.active = true
              AND NOT EXISTS (
                SELECT 1 FROM modifier_applicable_categories mac 
                WHERE mac.modifier_id = m.id AND mac.category_code = c.code
              );
        
        # Remove water repellent from categories that don't need it
        - sql:
            sql: |
              DELETE FROM modifier_applicable_categories
              WHERE modifier_id IN (SELECT id FROM price_modifiers WHERE code = 'WATER_REPELLENT')
              AND category_code IN ('IRONING', 'LAUNDRY', 'STAIN_REMOVAL', 'DYEING');
        
      rollback:
        - sql:
            sql: |
              DELETE FROM modifier_applicable_categories
              WHERE modifier_id IN (
                SELECT id FROM price_modifiers 
                WHERE code IN ('STAIN_REMOVAL_DYNAMIC', 'BUTTON_SEWING_DYNAMIC')
              );