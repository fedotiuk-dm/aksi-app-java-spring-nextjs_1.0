databaseChangeLog:
  - changeSet:
      id: item-009-link-modifiers-to-categories
      author: system
      comment: Link price modifiers to applicable service categories
      changes:
        # Текстильні модифікатори для відповідних категорій
        - sql:
            sql: >
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code
              FROM price_modifiers m
              CROSS JOIN service_categories c
              WHERE m.code IN (
                'FUR_COLLAR_CUFFS',
                'SILK_SATIN_CHIFFON', 
                'COMBINED_LEATHER_TEXTILE',
                'LARGE_TOYS_MANUAL',
                'BLACK_LIGHT_COLORS',
                'WEDDING_DRESS_TRAIN'
              )
              AND c.code IN ('CLOTHING', 'LAUNDRY', 'HOUSEHOLD')
              ON CONFLICT DO NOTHING;

        # Водовідштовхуюче покриття для текстилю та шкіри
        - sql:
            sql: >
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code
              FROM price_modifiers m
              CROSS JOIN service_categories c
              WHERE m.code = 'WATER_REPELLENT'
              AND c.code IN ('CLOTHING', 'LAUNDRY', 'HOUSEHOLD', 'FUR', 'LEATHER', 'SHOES')
              ON CONFLICT DO NOTHING;

        # Модифікатори для шкіряних виробів
        - sql:
            sql: >
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code
              FROM price_modifiers m
              CROSS JOIN service_categories c
              WHERE m.code IN (
                'LEATHER_IRONING',
                'DYEING_AFTER_OUR_CLEANING',
                'DYEING_AFTER_OTHER_CLEANING',
                'LEATHER_WITH_INSERTS',
                'PEARL_COATING',
                'SHEEPSKIN_ARTIFICIAL_FUR',
                'MANUAL_CLEANING_LEATHER'
              )
              AND c.code IN ('FUR', 'LEATHER', 'SHOES')
              ON CONFLICT DO NOTHING;

        # Ручна чистка для всіх категорій крім шкіри (у шкіри свій модифікатор)
        - sql:
            sql: >
              INSERT INTO modifier_applicable_categories (modifier_id, category_code)
              SELECT m.id, c.code
              FROM price_modifiers m
              CROSS JOIN service_categories c
              WHERE m.code = 'MANUAL_CLEANING'
              AND c.code NOT IN ('FUR', 'LEATHER', 'SHOES')
              ON CONFLICT DO NOTHING;

        # Примітка: Загальні модифікатори та знижки не додаються в цю таблицю,
        # оскільки вони застосовуються до всіх категорій (пуста колекція applicableCategories)

      rollback:
        - delete:
            tableName: modifier_applicable_categories
            where: modifier_id IS NOT NULL