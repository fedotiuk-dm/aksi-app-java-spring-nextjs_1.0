databaseChangeLog:
  - changeSet:
      id: 006-create-temp-table
      author: system
      comment: "Створення тимчасової таблиці для CSV"
      changes:
        - sql:
            sql: "CREATE TEMPORARY TABLE temp_price_list (category_code VARCHAR(255), catalog_number INT, name VARCHAR(255), unit_of_measure VARCHAR(50), base_price DECIMAL(10, 2), price_black DECIMAL(10, 2), price_color DECIMAL(10, 2), active BOOLEAN);"

  - changeSet:
      id: 006-load-csv-data
      author: system
      comment: "Завантаження CSV даних (файл має існувати)"
      changes:
        - sql:
            sql: "COPY temp_price_list FROM '/price_list.csv' DELIMITER ',' CSV HEADER;"
      rollback:
        - sql:
            sql: "TRUNCATE TABLE temp_price_list;"

  - changeSet:
      id: 006-insert-price-list-items
      author: system
      comment: "Вставка даних в основну таблицю"
      changes:
        - sql:
            sql: "INSERT INTO price_list_items (id, category_id, catalog_number, name, unit_of_measure, base_price, price_black, price_color, active, created_at, updated_at) SELECT gen_random_uuid(), sc.id, tpl.catalog_number, tpl.name, tpl.unit_of_measure, tpl.base_price, tpl.price_black, tpl.price_color, tpl.active, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP FROM temp_price_list tpl JOIN service_categories sc ON tpl.category_code = sc.code WHERE NOT EXISTS (SELECT 1 FROM price_list_items pli WHERE pli.category_id = sc.id AND pli.catalog_number = tpl.catalog_number AND pli.name = tpl.name);"

      rollback:
        - sql:
            sql: "TRUNCATE TABLE price_list_items CASCADE;"
