databaseChangeLog:
  - changeSet:
      id: 009-insert-category-modifiers-compact
      author: system
      comment: "Завантаження зв'язків категорій з модифікаторами (компактна версія)"
      preConditions:
        - onFail: MARK_RAN
        - sqlCheck:
            expectedResult: 0
            sql: "SELECT COUNT(*) FROM service_category_modifiers"
      changes:
        # Загальні модифікатори (всі категорії)
        - sql:
            sql: |
              WITH general_modifiers AS (
                SELECT unnest(ARRAY['CHILDREN_ITEMS','MANUAL_CLEANING','HEAVILY_SOILED_MIN','HEAVILY_SOILED_MAX','URGENT_48H','URGENT_24H']) as modifier_code
              ),
              all_categories AS (
                SELECT id, code FROM service_categories
              )
              INSERT INTO service_category_modifiers (category_id, modifier_id)
              SELECT
                ac.id as category_id,
                pm.id as modifier_id
              FROM all_categories ac
              CROSS JOIN general_modifiers gm
              JOIN price_modifiers pm ON pm.code = gm.modifier_code
              WHERE NOT EXISTS (
                SELECT 1 FROM service_category_modifiers scm
                WHERE scm.category_id = ac.id AND scm.modifier_id = pm.id
              );

        # Текстильні модифікатори
        - sql:
            sql: |
              WITH textile_modifiers AS (
                SELECT unnest(ARRAY['FUR_COLLARS','WATER_REPELLENT_TEXTILE','NATURAL_SILK','LEATHER_TEXTILE_COMBO','LARGE_SOFT_TOYS','BUTTON_SEWING','BLACK_LIGHT_COLORS','WEDDING_DRESS']) as modifier_code
              ),
              textile_categories AS (
                SELECT id FROM service_categories
                WHERE code IN ('CLOTHING','LAUNDRY','IRONING','DYEING','ADDITIONAL_SERVICES')
              )
              INSERT INTO service_category_modifiers (category_id, modifier_id)
              SELECT
                tc.id as category_id,
                pm.id as modifier_id
              FROM textile_categories tc
              CROSS JOIN textile_modifiers tm
              JOIN price_modifiers pm ON pm.code = tm.modifier_code
              WHERE NOT EXISTS (
                SELECT 1 FROM service_category_modifiers scm
                WHERE scm.category_id = tc.id AND scm.modifier_id = pm.id
              );

        # Шкіряні модифікатори
        - sql:
            sql: |
              WITH leather_modifiers AS (
                SELECT unnest(ARRAY['LEATHER_IRONING','WATER_REPELLENT_LEATHER','DYEING_AFTER_OUR','DYEING_AFTER_OTHER','LEATHER_INSERTS','PEARL_COATING','ARTIFICIAL_FUR_DISCOUNT','MANUAL_LEATHER']) as modifier_code
              ),
              leather_categories AS (
                SELECT id FROM service_categories
                WHERE code IN ('LEATHER','PADDING','FUR')
              )
              INSERT INTO service_category_modifiers (category_id, modifier_id)
              SELECT
                lc.id as category_id,
                pm.id as modifier_id
              FROM leather_categories lc
              CROSS JOIN leather_modifiers lm
              JOIN price_modifiers pm ON pm.code = lm.modifier_code
              WHERE NOT EXISTS (
                SELECT 1 FROM service_category_modifiers scm
                WHERE scm.category_id = lc.id AND scm.modifier_id = pm.id
              );

      rollback:
        - delete:
            tableName: service_category_modifiers
