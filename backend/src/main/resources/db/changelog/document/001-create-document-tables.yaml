databaseChangeLog:
  # Створення основної таблиці documents
  - changeSet:
      id: 001-create-documents-table
      author: system
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: documents
      changes:
        - createTable:
            tableName: documents
            columns:
              # BaseEntity поля
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT
                  defaultValue: "0"

              # DocumentEntity основні поля
              - column:
                  name: document_number
                  type: VARCHAR(100)
              - column:
                  name: type
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
              - column:
                  name: related_entity_id
                  type: UUID
              - column:
                  name: file_name
                  type: VARCHAR(255)
              - column:
                  name: file_path
                  type: VARCHAR(500)
              - column:
                  name: file_size
                  type: BIGINT
              - column:
                  name: mime_type
                  type: VARCHAR(100)
              - column:
                  name: status
                  type: VARCHAR(20)
                  constraints:
                    nullable: false
                  defaultValue: "DRAFT"
              - column:
                  name: download_url
                  type: VARCHAR(500)
              - column:
                  name: created_by
                  type: VARCHAR(100)
              - column:
                  name: metadata
                  type: JSON

  # Створення таблиці receipts
  - changeSet:
      id: 002-create-receipts-table
      author: system
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: receipts
      changes:
        - createTable:
            tableName: receipts
            columns:
              # BaseEntity поля
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT
                  defaultValue: "0"

              # ReceiptEntity основні поля
              - column:
                  name: order_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: receipt_number
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: data
                  type: JSON
              - column:
                  name: pdf_document_id
                  type: BIGINT
              - column:
                  name: qr_code_id
                  type: UUID
              - column:
                  name: is_printed
                  type: BOOLEAN
                  defaultValue: "false"
              - column:
                  name: printed_at
                  type: TIMESTAMP
              - column:
                  name: generated_at
                  type: TIMESTAMP
              - column:
                  name: generated_by
                  type: VARCHAR(100)

  # Створення таблиці digital_signatures
  - changeSet:
      id: 003-create-digital-signatures-table
      author: system
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: digital_signatures
      changes:
        - createTable:
            tableName: digital_signatures
            columns:
              # BaseEntity поля
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
              - column:
                  name: version
                  type: BIGINT
                  defaultValue: "0"

              # DigitalSignatureEntity основні поля
              - column:
                  name: document_id
                  type: UUID
              - column:
                  name: type
                  type: VARCHAR(30)
                  constraints:
                    nullable: false
              - column:
                  name: signer_name
                  type: VARCHAR(200)
              - column:
                  name: signer_role
                  type: VARCHAR(100)
              - column:
                  name: signed_at
                  type: TIMESTAMP
              - column:
                  name: ip_address
                  type: VARCHAR(45)
              - column:
                  name: image_url
                  type: VARCHAR(500)
              - column:
                  name: metadata
                  type: JSON
              - column:
                  name: is_valid
                  type: BOOLEAN
                  defaultValue: "true"
              - column:
                  name: receipt_id
                  type: BIGINT

  # Додавання Foreign Key constraints
  - changeSet:
      id: 004-add-foreign-key-constraints
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: receipts
            - tableExists:
                tableName: documents
            - tableExists:
                tableName: digital_signatures
            - not:
                - foreignKeyConstraintExists:
                    foreignKeyName: fk_receipts_pdf_document_id
      changes:
        - addForeignKeyConstraint:
            baseTableName: receipts
            baseColumnNames: pdf_document_id
            constraintName: fk_receipts_pdf_document_id
            referencedTableName: documents
            referencedColumnNames: id
            onDelete: SET NULL
        - addForeignKeyConstraint:
            baseTableName: digital_signatures
            baseColumnNames: receipt_id
            constraintName: fk_digital_signatures_receipt_id
            referencedTableName: receipts
            referencedColumnNames: id
            onDelete: CASCADE

  # Створення індексів для продуктивності
  - changeSet:
      id: 005-create-documents-indexes
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: documents
            - not:
                - indexExists:
                    indexName: idx_document_type
      changes:
        # Documents індекси
        - createIndex:
            indexName: idx_document_type
            tableName: documents
            columns:
              - column:
                  name: type
        - createIndex:
            indexName: idx_document_status
            tableName: documents
            columns:
              - column:
                  name: status
        - createIndex:
            indexName: idx_document_related_entity
            tableName: documents
            columns:
              - column:
                  name: related_entity_id
        - createIndex:
            indexName: idx_document_number
            tableName: documents
            columns:
              - column:
                  name: document_number
        - createIndex:
            indexName: idx_document_created_by
            tableName: documents
            columns:
              - column:
                  name: created_by

  # Створення індексів для receipts
  - changeSet:
      id: 006-create-receipts-indexes
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: receipts
            - not:
                - indexExists:
                    indexName: idx_receipt_order_id
      changes:
        - createIndex:
            indexName: idx_receipt_order_id
            tableName: receipts
            columns:
              - column:
                  name: order_id
        - createIndex:
            indexName: idx_receipt_number
            tableName: receipts
            unique: true
            columns:
              - column:
                  name: receipt_number
        - createIndex:
            indexName: idx_receipt_printed
            tableName: receipts
            columns:
              - column:
                  name: is_printed
        - createIndex:
            indexName: idx_receipt_generated_by
            tableName: receipts
            columns:
              - column:
                  name: generated_by

  # Створення індексів для digital_signatures
  - changeSet:
      id: 007-create-digital-signatures-indexes
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: digital_signatures
            - not:
                - indexExists:
                    indexName: idx_signature_document_id
      changes:
        - createIndex:
            indexName: idx_signature_document_id
            tableName: digital_signatures
            columns:
              - column:
                  name: document_id
        - createIndex:
            indexName: idx_signature_type
            tableName: digital_signatures
            columns:
              - column:
                  name: type
        - createIndex:
            indexName: idx_signature_signer_name
            tableName: digital_signatures
            columns:
              - column:
                  name: signer_name
        - createIndex:
            indexName: idx_signature_signed_at
            tableName: digital_signatures
            columns:
              - column:
                  name: signed_at
        - createIndex:
            indexName: idx_signature_valid
            tableName: digital_signatures
            columns:
              - column:
                  name: is_valid

  # Додавання check constraints для enum полів
  - changeSet:
      id: 008-add-document-enum-constraints
      author: system
      preConditions:
        - onFail: MARK_RAN
        - tableExists:
            tableName: documents
      changes:
        - sql:
            sql: >
              ALTER TABLE documents ADD CONSTRAINT chk_document_type
              CHECK (type IN ('RECEIPT', 'CONTRACT', 'INVOICE', 'PHOTO', 'QR_CODE', 'SIGNATURE'));
        - sql:
            sql: >
              ALTER TABLE documents ADD CONSTRAINT chk_document_status
              CHECK (status IN ('DRAFT', 'GENERATED', 'SIGNED', 'PRINTED', 'ARCHIVED'));
        - sql:
            sql: >
              ALTER TABLE digital_signatures ADD CONSTRAINT chk_signature_type
              CHECK (type IN ('CLIENT_HANDOVER', 'CLIENT_PICKUP', 'OPERATOR', 'DIGITAL'));

  # Додавання коментарів до таблиць
  - changeSet:
      id: 009-add-table-comments
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: documents
            - tableExists:
                tableName: receipts
            - tableExists:
                tableName: digital_signatures
      changes:
        - sql:
            sql: COMMENT ON TABLE documents IS 'Основна таблиця документів системи';
        - sql:
            sql: COMMENT ON TABLE receipts IS 'Таблиця квитанцій для замовлень';
        - sql:
            sql: COMMENT ON TABLE digital_signatures IS 'Таблиця цифрових підписів';

  # Додавання коментарів до основних колонок
  - changeSet:
      id: 010-add-column-comments
      author: system
      preConditions:
        - onFail: MARK_RAN
        - and:
            - tableExists:
                tableName: documents
            - tableExists:
                tableName: receipts
            - tableExists:
                tableName: digital_signatures
      changes:
        - sql:
            sql: COMMENT ON COLUMN documents.document_number IS 'Унікальний номер документа';
        - sql:
            sql: COMMENT ON COLUMN documents.type IS 'Тип документа (RECEIPT, CONTRACT, INVOICE, PHOTO, QR_CODE, SIGNATURE)';
        - sql:
            sql: COMMENT ON COLUMN documents.status IS 'Статус документа (DRAFT, GENERATED, SIGNED, PRINTED, ARCHIVED)';
        - sql:
            sql: COMMENT ON COLUMN documents.related_entity_id IS 'UUID пов''язаної сутності (замовлення, клієнта тощо)';
        - sql:
            sql: COMMENT ON COLUMN documents.metadata IS 'Додаткові метадані в JSON форматі';
        - sql:
            sql: COMMENT ON COLUMN receipts.order_id IS 'UUID замовлення для якого створено квитанцію';
        - sql:
            sql: COMMENT ON COLUMN receipts.receipt_number IS 'Унікальний номер квитанції';
        - sql:
            sql: COMMENT ON COLUMN receipts.data IS 'Дані квитанції в JSON форматі';
        - sql:
            sql: COMMENT ON COLUMN digital_signatures.type IS 'Тип підпису (CLIENT_HANDOVER, CLIENT_PICKUP, OPERATOR, DIGITAL)';
        - sql:
            sql: COMMENT ON COLUMN digital_signatures.is_valid IS 'Чи є підпис дійсним';
        - sql:
            sql: COMMENT ON COLUMN digital_signatures.metadata IS 'Метадані підпису в JSON форматі';
