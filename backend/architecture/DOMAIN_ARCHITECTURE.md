# Доменна архітектура системи управління хімчисткою

## Огляд архітектури

Система побудована на основі Domain-Driven Design (DDD) принципів з чітким розподілом на окремі домени. Кожен домен інкапсулює свою бізнес-логіку та відповідає за конкретну область системи.

## Структура доменів

### 1. Auth Domain (Домен автентифікації)
**Відповідальність**: Автентифікація та управління сесіями

**Основні компоненти**:
- Cookie-based автентифікація (httpOnly, secure)
- Управління сесіями
- CSRF захист
- Refresh token механізм

**Ключові сутності**:
- `Session` - активна сесія
- `RefreshToken` - токен оновлення
- `AuthenticationAttempt` - спроба входу

### 2. User Domain (Домен користувачів)
**Відповідальність**: Управління користувачами системи (операторами)

**Основні компоненти**:
- Управління профілями операторів
- Рольова модель (оператор, менеджер, адміністратор)
- Прив'язка до філій
- Історія активності

**Ключові сутності**:
- `User` - користувач системи (оператор)
- `Role` - роль користувача
- `Permission` - дозволи
- `UserBranch` - прив'язка до філій

### 3. Customer Domain (Домен клієнтів)
**Відповідальність**: Управління інформацією про клієнтів хімчистки

**Основні компоненти**:
- Реєстрація нових клієнтів
- Пошук та управління існуючими клієнтами
- Управління контактними даними
- Історія взаємодії з клієнтом

**Ключові сутності**:
- `Customer` - клієнт
- `ContactInfo` - контактна інформація
- `CommunicationPreference` - налаштування комунікації
- `CustomerSource` - джерело залучення клієнта

### 4. Branch Domain (Домен філій)
**Відповідальність**: Управління пунктами прийому замовлень

**Основні компоненти**:
- Інформація про філії
- Графік роботи
- Контактні дані філії
- Прив'язка операторів до філій

**Ключові сутності**:
- `Branch` - філія/пункт прийому
- `WorkSchedule` - графік роботи
- `BranchOperator` - прив'язка операторів

### 5. Service Domain (Домен послуг)
**Відповідальність**: Управління каталогом послуг та прайс-листом

**Основні компоненти**:
- Категорії послуг (чистка одягу, прання, прасування, шкіра, хутро)
- Базові ціни на послуги
- Прайс-лист з CSV
- Одиниці виміру (штуки, кілограми, квадратні метри)
- Зв'язок послуг з предметами через ServiceItem

**Ключові сутності**:
- `ServiceCategory` - категорія послуги  
- `Service` - конкретна послуга
- `Item` - предмет з прайс-листа
- `ServiceItem` - зв'язок послуги та предмета з ціною
- `PriceListItem` - елемент прайс-листа для імпорту

### 6. Pricing Domain (Домен ціноутворення)
**Відповідальність**: Розрахунок вартості з урахуванням всіх модифікаторів

**Основні компоненти**:
- Модифікатори ціни (терміновість, забрудненість, дитячі речі)
- Правила розрахунку
- Знижки та надбавки
- Калькулятор вартості

**Ключові сутності**:
- `PriceModifier` - модифікатор ціни
- `ModifierRule` - правило застосування модифікатора
- `Discount` - знижка
- `Surcharge` - надбавка
- `PriceCalculation` - розрахунок ціни

### 7. Order Domain (Домен замовлень)
**Відповідальність**: Управління життєвим циклом замовлень та характеристиками предметів

**Основні компоненти**:
- Корзина для тимчасового зберігання та розрахунку цін
- Інтерактивний калькулятор цін в реальному часі
- Створення замовлень з корзини
- Управління статусами
- Фіксація характеристик предметів при прийомі
- Фотографування предметів та дефектів
- Розрахунок термінів виконання

**Ключові сутності**:

**Корзина (тимчасове сховище до створення замовлення)**:
- `OrderCart` - корзина для зберігання предметів та розрахунку
- `CartItem` - предмет в корзині з характеристиками
- `CartItemPricing` - детальний розрахунок ціни предмета
- `CartPricing` - загальний розрахунок корзини з урахуванням знижок

**Замовлення**:
- `Order` - замовлення
- `OrderItem` - предмет в замовленні з усіма характеристиками
- `OrderItemCharacteristics` - матеріал, колір, наповнювач предмета
- `OrderItemPhoto` - фотографія предмета в замовленні
- `OrderItemDefect` - дефекти та пошкодження
- `OrderItemStain` - плями та забруднення
- `OrderStatus` - статус замовлення
- `OrderTimeline` - часова лінія замовлення
- `UniqueLabel` - унікальна мітка (QR-код)

### 8. Payment Domain (Домен платежів)
**Відповідальність**: Обробка платежів та фінансові операції

**Основні компоненти**:
- Реєстрація платежів
- Способи оплати
- Передоплата та борги
- Фінансова звітність

**Ключові сутності**:
- `Payment` - платіж
- `PaymentMethod` - спосіб оплати
- `Invoice` - рахунок
- `PaymentTransaction` - транзакція

### 9. Receipt Domain (Домен квитанцій)
**Відповідальність**: Формування та друк квитанцій

**Основні компоненти**:
- Генерація квитанцій
- Шаблони квитанцій
- Цифрові підписи
- QR-коди для відстеження

**Ключові сутності**:
- `Receipt` - квитанція
- `ReceiptTemplate` - шаблон квитанції
- `DigitalSignature` - цифровий підпис
- `ReceiptQRCode` - QR-код квитанції

### 11. Notification Domain (Домен сповіщень)
**Відповідальність**: Відправка сповіщень клієнтам

**Основні компоненти**:
- SMS сповіщення
- Viber повідомлення
- Email розсилка
- Шаблони повідомлень

**Ключові сутності**:
- `NotificationTemplate` - шаблон повідомлення
- `NotificationLog` - лог відправлених повідомлень
- `NotificationChannel` - канал комунікації

### 12. Configuration Domain (Домен конфігурації)
**Відповідальність**: Централізоване управління налаштуваннями системи

**Основні компоненти**:
- Глобальні налаштування
- Конфігурація модифікаторів
- Налаштування знижок
- Бізнес-правила

**Ключові сутності**:
- `SystemConfiguration` - системні налаштування
- `BusinessRule` - бізнес-правило
- `ConfigurationHistory` - історія змін

### 13. Reporting Domain (Домен звітності)
**Відповідальність**: Формування звітів та аналітика

**Основні компоненти**:
- Фінансові звіти
- Операційні звіти
- Аналітика по клієнтах
- Статистика по послугах

**Ключові сутності**:
- `Report` - звіт
- `ReportTemplate` - шаблон звіту
- `Analytics` - аналітичні дані

## Shared/Common модулі

### Common Domain Models
- `Money` - робота з грошовими сумами
- `DateRange` - часові проміжки
- `Address` - адреса
- `PhoneNumber` - телефонний номер
- `Email` - email адреса

### Common Services
- `ValidationService` - валідація даних
- `AuditService` - аудит змін
- `FileStorageService` - збереження файлів
- `QRCodeService` - генерація QR-кодів

## Взаємозв'язки між доменами

### Order -> Customer
- Замовлення завжди прив'язане до клієнта
- Історія замовлень клієнта

### Order -> Service
- Кожен OrderItem прив'язаний до конкретного ServiceItem
- ServiceItem визначає базову ціну та послугу

### Order характеристики
- Характеристики предметів (матеріал, колір, дефекти) зберігаються в OrderItem
- Фотографії робляться при створенні замовлення та прив'язуються до OrderItem

### Cart -> Service + Pricing
- Cart використовує Service для отримання базових цін
- Cart викликає Pricing для розрахунку з усіма модифікаторами
- Інтерактивний перерахунок при зміні параметрів

### Cart -> Order
- Order створюється з готової корзини
- Всі розрахунки та характеристики переносяться з Cart
- Cart видаляється після створення Order

### Order -> Pricing
- Розрахунок вартості для кожного предмета
- Застосування модифікаторів та знижок

### Order -> Payment
- Реєстрація платежів по замовленню
- Контроль заборгованості

### Order -> Receipt
- Генерація квитанції при створенні замовлення
- Друк квитанції

### Order -> Branch
- Замовлення прив'язане до філії
- Оператор філії створює замовлення

### Customer -> Notification
- Відправка сповіщень згідно налаштувань клієнта
- Історія комунікації

## Технічні рекомендації

### 1. Модульність
- Кожен домен - окремий Spring Boot модуль
- Чітко визначені API між модулями
- Мінімальні залежності між доменами

### 2. База даних
- Можливість використання різних схем БД для доменів
- Транзакційна цілісність в межах домену
- Eventual consistency між доменами

### 3. API Gateway
- Єдина точка входу для frontend
- Агрегація даних з різних доменів
- Авторизація на рівні gateway

### 4. Event-Driven Architecture
- Домени комунікують через події
- Event sourcing для критичних операцій
- Асинхронна обробка де можливо

### 5. Масштабованість
- Можливість окремого масштабування доменів
- Використання кешування
- Оптимізація запитів до БД

## Як модулі спілкуються між собою

### 1. Монолітна архітектура (рекомендовано для старту)
В рамках одного Spring Boot додатку модулі представляють собою окремі пакети:

```
- Модулі = Spring components в різних пакетах
- Комунікація через Spring dependency injection
- Спільна база даних з логічним розділенням схем
- Транзакції через @Transactional
```

**Приклад взаємодії:**

```java

@Service
public record OrderService(CustomerService customerService, PricingService pricingService) {
  public Order createOrder(CreateOrderRequest request) {
    // Прямий виклик через DI
    Customer customer = customerService.findById(request.getCustomerId());
    PriceCalculation price = pricingService.calculate(request.getItems());
    // ...
  }
}
```

### 2. Модульний моноліт (наступний крок)
Окремі Maven модулі в рамках одного деплойменту:

```
- Кожен домен = окремий Maven модуль
- Чіткі інтерфейси між модулями
- Можливість окремого версіонування
- Спільний application context
```

**Структура залежностей:**
```
dry-cleaning-order залежить від:
  - dry-cleaning-customer-api (інтерфейси)
  - dry-cleaning-pricing-api (інтерфейси)
  - dry-cleaning-common
```

### 3. Мікросервіси (при потребі масштабування)
Повністю незалежні сервіси:

```
- Кожен домен = окремий мікросервіс
- REST або gRPC для синхронної комунікації
- Message broker для асинхронних подій
- Окремі бази даних
```

## Спрощення архітектури

### Що можна об'єднати для простоти:

1. **Service Domain вже об'єднує каталог:**
   - Service - категорії послуг
   - Item - предмети з прайс-листа
   - ServiceItem - зв'язок з цінами

2. **Configuration можна розподілити:**
   - Конфігурація цін → Pricing домен
   - Конфігурація повідомлень → Notification домен
   - Системні налаштування → application.yml

3. **Reporting спочатку може бути частиною Order:**
   - Прості звіти через JPA queries
   - Окремий домен - коли з'явиться складна аналітика

### Мінімальний набір для MVP:
1. **Auth** - автентифікація
2. **User** - користувачі системи
3. **Customer** - клієнти
4. **Order** - замовлення (включає характеристики предметів)
5. **Pricing** - розрахунки
6. **Receipt** - квитанції

Решту доменів можна додавати поступово.