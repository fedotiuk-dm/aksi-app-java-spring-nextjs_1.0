# Makefile for AKSI Dry Cleaning Order System
# Usage: make [target]

# Variables
COMPOSE_FILE := docker-compose.dev.backend.yml
DOCKER_COMPOSE := docker-compose -f $(COMPOSE_FILE)
MVN := ./mvnw

# Default target
.DEFAULT_GOAL := help

# Phony targets
.PHONY: help up down stop start restart logs status shell clean reset db build test lint format dev install

# Help target
help: ## Show this help message
	@echo 'AKSI Dry Cleaning Order System - Development Environment'
	@echo ''
	@echo 'Usage:'
	@echo '  make [target]'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ''
	@echo 'Quick Start:'
	@echo '  make install         # Install dependencies'
	@echo '  make up              # Start all services'
	@echo '  make dev             # Start development mode'
	@echo '  make logs            # View logs'
	@echo '  make down            # Stop all services'
	@echo ''
	@echo 'URLs:'
	@echo '  Application:         http://localhost:8080'
	@echo '  API:                 http://localhost:8080/api'
	@echo '  Swagger UI:          http://localhost:8080/swagger-ui.html'

# Install dependencies
install: ## Install Maven dependencies
	@echo 'ğŸ“¦ Installing dependencies...'
	@$(MVN) clean install -DskipTests
	@echo 'âœ… Dependencies installed!'

# Start services
up: ## Start all services with Docker
	@echo 'ğŸš€ Starting all services...'
	@$(DOCKER_COMPOSE) up -d
	@echo 'âœ… All services started!'
	@make _show_urls

# Development mode
dev: ## Start development mode (Spring Boot)
	@echo 'ğŸš€ Starting development mode...'
	@$(MVN) spring-boot:run -Dspring-boot.run.profiles=dev

# Stop services
down: ## Stop all Docker services
	@echo 'ğŸ›‘ Stopping all services...'
	@$(DOCKER_COMPOSE) down
	@echo 'âœ… All services stopped!'

# Stop services (alias)
stop: down ## Stop all services (alias for down)

# Start existing services
start: ## Start existing Docker services
	@echo 'â–¶ï¸  Starting existing services...'
	@$(DOCKER_COMPOSE) start
	@echo 'âœ… Services started!'

# Restart services
restart: ## Restart all Docker services
	@echo 'ğŸ”„ Restarting services...'
	@$(DOCKER_COMPOSE) restart
	@echo 'âœ… Services restarted!'

# View logs
logs: ## View logs from all services
	@echo 'ğŸ“º Showing logs (Ctrl+C to exit)...'
	@$(DOCKER_COMPOSE) logs -f

# Status
status: ## Show status of all services
	@echo 'ğŸ“Š Container status:'
	@$(DOCKER_COMPOSE) ps
	@echo ''
	@echo 'ğŸŒ Active services:'
	@$(DOCKER_COMPOSE) port postgres 5432 2>/dev/null && echo "PostgreSQL: localhost:5432" || echo "PostgreSQL: not running"

# Shell access
shell: ## Connect to Spring Boot application
	@echo 'ğŸš Starting bash shell...'
	@bash

# Database shell
db-shell: ## Connect to PostgreSQL
	@echo 'ğŸ—„ï¸ Connecting to PostgreSQL...'
	@$(DOCKER_COMPOSE) exec postgres psql -U aksi_user -d aksi_dry_cleaning

# Reset database
reset-db: ## Reset database (WARNING: deletes all data)
	@echo 'âš ï¸  WARNING! This will delete all database data!'
	@echo 'Are you sure? (y/N)'
	@read -p "" confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo 'ğŸ—‘ï¸ Resetting database...'; \
		$(DOCKER_COMPOSE) down -v; \
		$(DOCKER_COMPOSE) up -d postgres; \
		sleep 5; \
		$(MVN) liquibase:update; \
		echo 'âœ… Database reset complete!'; \
	else \
		echo 'Operation cancelled.'; \
	fi

# Build project
build: ## Build project with Maven
	@echo 'ğŸ”¨ Building project...'
	@$(MVN) clean package -DskipTests
	@echo 'âœ… Build complete!'

# Run tests
test: ## Run all tests
	@echo 'ğŸ§ª Running tests...'
	@$(MVN) test
	@echo 'âœ… Tests complete!'

# Run integration tests
test-integration: ## Run integration tests
	@echo 'ğŸ§ª Running integration tests...'
	@$(MVN) verify -P integration-tests
	@echo 'âœ… Integration tests complete!'

# Lint code
lint: ## Run code linting
	@echo 'ğŸ” Running linting...'
	@$(MVN) spotless:check checkstyle:check
	@echo 'âœ… Linting complete!'

# Format code
format: ## Format code
	@echo 'âœ¨ Formatting code...'
	@$(MVN) spotless:apply
	@echo 'âœ… Formatting complete!'

# Generate API
generate-api: ## Generate API from OpenAPI specs
	@echo 'ğŸ”„ Generating API...'
	@$(MVN) clean compile
	@echo 'âœ… API generation complete!'

# Database operations
db-migrate: ## Run database migrations
	@echo 'ğŸ—„ï¸ Running migrations...'
	@$(MVN) liquibase:update
	@echo 'âœ… Migrations complete!'

db-rollback: ## Rollback last database migration
	@echo 'âª Rolling back last migration...'
	@$(MVN) liquibase:rollback -Dliquibase.rollbackCount=1
	@echo 'âœ… Rollback complete!'

db-status: ## Show database migration status
	@echo 'ğŸ“Š Database migration status:'
	@$(MVN) liquibase:status

# Docker operations
docker-build: ## Build Docker image
	@echo 'ğŸ³ Building Docker image...'
	@docker build -t aksi/dry-cleaning:latest .
	@echo 'âœ… Docker image built!'

# Clean
clean: ## Clean build artifacts
	@echo 'ğŸ§¹ Cleaning build artifacts...'
	@$(MVN) clean
	@rm -rf target/
	@echo 'âœ… Clean complete!'

# Production build
prod: ## Build for production
	@echo 'ğŸš€ Building for production...'
	@$(MVN) clean package -P production
	@echo 'âœ… Production build complete!'

# Private targets
_show_urls:
	@echo ''
	@echo 'ğŸŒ Service URLs:'
	@echo '   Application:         http://localhost:8080'
	@echo '   API:                 http://localhost:8080/api'
	@echo '   Swagger UI:          http://localhost:8080/swagger-ui.html'
	@echo '   Actuator:            http://localhost:8080/actuator'
	@echo ''
	@echo 'ğŸ› ï¸  Useful commands:'
	@echo '   make logs            # View logs'
	@echo '   make status          # Check status'
	@echo '   make shell           # Open shell'
	@echo '   make down            # Stop all services'

# Monitoring
monitor: ## Open monitoring dashboards
	@echo 'ğŸ“Š Monitoring URLs:'
	@echo '   Actuator:            http://localhost:8080/actuator'

# Security check
security-check: ## Run security checks
	@echo 'ğŸ”’ Running security checks...'
	@$(MVN) dependency-check:check
	@echo 'âœ… Security check complete!'

# Update dependencies
update-deps: ## Update Maven dependencies
	@echo 'ğŸ“¦ Updating dependencies...'
	@$(MVN) versions:use-latest-versions
	@echo 'âœ… Dependencies updated!'

# Show outdated dependencies
outdated: ## Show outdated dependencies
	@echo 'ğŸ“¦ Checking for outdated dependencies...'
	@echo 'Maven:'
	@$(MVN) versions:display-dependency-updates
