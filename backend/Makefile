# Makefile for AKSI Dry Cleaning Order System
# Usage: make [target]

# Variables
COMPOSE_FILE := docker-compose.dev.backend.yml
DOCKER_COMPOSE := docker-compose -f $(COMPOSE_FILE)
MVN := ./mvnw

# Default target
.DEFAULT_GOAL := help

# Dependency update targets
.PHONY: update-versions check-updates update-properties update-dependencies update-plugins

# Phony targets
.PHONY: help up down stop start restart logs status shell clean reset db build test lint format dev install bundle-api generate-docs update-docs

# Help target
help: ## Show this help message
	@echo 'AKSI Dry Cleaning Order System - Development Environment'
	@echo ''
	@echo 'Usage:'
	@echo '  make [target]'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ''
	@echo 'Quick Start:'
	@echo '  make install         # Install dependencies'
	@echo '  make up              # Start all services'
	@echo '  make dev             # Start development mode'
	@echo '  make logs            # View logs'
	@echo '  make down            # Stop all services'
	@echo ''
	@echo 'URLs:'
	@echo '  Application:         http://localhost:8080'
	@echo '  API:                 http://localhost:8080/api'
	@echo '  Swagger UI:          http://localhost:8080/swagger-ui.html'

# Install dependencies
install: ## Install Maven dependencies
	@echo 'ğŸ“¦ Installing dependencies...'
	@$(MVN) clean install -DskipTests
	@echo 'âœ… Dependencies installed!'

# Start services
up: ## Start all services with Docker
	@echo 'ğŸš€ Starting all services...'
	@$(DOCKER_COMPOSE) up -d
	@echo 'âœ… All services started!'
	@make _show_urls

# Development mode
dev: ## Start development mode (Spring Boot)
	@echo 'ğŸš€ Starting development mode...'
	@$(MVN) spring-boot:run -Dspring-boot.run.profiles=dev

# Stop services
down: ## Stop all Docker services
	@echo 'ğŸ›‘ Stopping all services...'
	@$(DOCKER_COMPOSE) down
	@echo 'âœ… All services stopped!'

# Stop services (alias)
stop: down ## Stop all services (alias for down)

# Start existing services
start: ## Start existing Docker services
	@echo 'â–¶ï¸  Starting existing services...'
	@$(DOCKER_COMPOSE) start
	@echo 'âœ… Services started!'

# Restart services
restart: ## Restart all Docker services
	@echo 'ğŸ”„ Restarting services...'
	@$(DOCKER_COMPOSE) restart
	@echo 'âœ… Services restarted!'

# View logs
logs: ## View logs from all services
	@echo 'ğŸ“º Showing logs (Ctrl+C to exit)...'
	@$(DOCKER_COMPOSE) logs -f

# Status
status: ## Show status of all services
	@echo 'ğŸ“Š Container status:'
	@$(DOCKER_COMPOSE) ps
	@echo ''
	@echo 'ğŸŒ Active services:'
	@$(DOCKER_COMPOSE) port postgres 5432 2>/dev/null && echo "PostgreSQL: localhost:5432" || echo "PostgreSQL: not running"

# Shell access
shell: ## Connect to Spring Boot application
	@echo 'ğŸš Starting bash shell...'
	@bash

# Database shell
db-shell: ## Connect to PostgreSQL
	@echo 'ğŸ—„ï¸ Connecting to PostgreSQL...'
	@$(DOCKER_COMPOSE) exec postgres psql -U aksi_user -d aksi_dry_cleaning

# Reset database
reset-db: ## Reset database (WARNING: deletes all data)
	@echo 'âš ï¸  WARNING! This will delete all database data!'
	@echo 'Are you sure? (y/N)'
	@read -p "" confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo 'ğŸ—‘ï¸ Resetting database...'; \
		$(DOCKER_COMPOSE) down -v; \
		$(DOCKER_COMPOSE) up -d postgres; \
		sleep 5; \
		$(MVN) liquibase:update; \
		echo 'âœ… Database reset complete!'; \
	else \
		echo 'Operation cancelled.'; \
	fi

# Build project
build: ## Build project with Maven
	@echo 'ğŸ”¨ Building project...'
	@$(MVN) clean package -DskipTests
	@echo 'âœ… Build complete!'

# Run tests
test: ## Run all tests
	@echo 'ğŸ§ª Running tests...'
	@$(MVN) test
	@echo 'âœ… Tests complete!'

# Run integration tests
test-integration: ## Run integration tests
	@echo 'ğŸ§ª Running integration tests...'
	@$(MVN) verify -P integration-tests
	@echo 'âœ… Integration tests complete!'

# Lint code
lint: ## Run code linting
	@echo 'ğŸ” Running linting...'
	@$(MVN) spotless:check checkstyle:check
	@echo 'âœ… Linting complete!'

# Format code
format: ## Format code
	@echo 'âœ¨ Formatting code...'
	@$(MVN) spotless:apply
	@echo 'âœ… Formatting complete!'

# Generate API
generate-api: ## Generate API from OpenAPI specs
	@echo 'ğŸ”„ Generating API...'
	@$(MVN) clean compile
	@echo 'âœ… API generation complete!'

# API Documentation operations
bundle-api: ## Generate API bundle from all domain specs
	@echo 'ğŸ”„ Generating API bundle...'
	@cd src/main/resources/openapi && \
	npx @redocly/cli bundle \
	  common.yaml \
	  auth/auth-api.yaml \
	  branch/branch-api.yaml \
	  cart/cart-api.yaml \
	  customer/customer-api.yaml \
	  file/file-api.yaml \
	  games/games-api.yaml \
	  order/order-api.yaml \
	  price-list/price-list-api.yaml \
	  pricing/pricing-api.yaml \
	  receipt/receipt-api.yaml \
	  user/user-api.yaml \
	  --output temp-bundle --force
	@cd src/main/resources/openapi && \
	npx @redocly/cli join temp-bundle/*.yaml --output aksi-bundled-new.yaml
	@cd src/main/resources/openapi && \
	if [ -f aksi-bundled.yaml ]; then cp aksi-bundled.yaml aksi-bundled-backup.yaml; fi && \
	mv aksi-bundled-new.yaml aksi-bundled.yaml && \
	rm -rf temp-bundle
	@echo 'âœ… API bundle updated!'

generate-docs: ## Generate HTML documentation from API bundle
	@echo 'ğŸ“š Generating HTML documentation...'
	@mkdir -p src/main/docs/api
	@cd src/main/resources/openapi && \
	npx @redocly/cli build-docs aksi-bundled.yaml --output ../docs/api/index.html
	@echo 'âœ… HTML documentation generated at src/main/docs/api/index.html!'

update-docs: bundle-api generate-docs ## Update both API bundle and HTML docs
	@echo 'ğŸ‰ API bundle and documentation updated successfully!'
	@echo 'ğŸ“ Bundle: backend/src/main/resources/openapi/aksi-bundled.yaml'
	@echo 'ğŸŒ Docs:   backend/src/main/docs/api/index.html'

# Database operations
db-migrate: ## Run database migrations
	@echo 'ğŸ—„ï¸ Running migrations...'
	@$(MVN) liquibase:update
	@echo 'âœ… Migrations complete!'

db-rollback: ## Rollback last database migration
	@echo 'âª Rolling back last migration...'
	@$(MVN) liquibase:rollback -Dliquibase.rollbackCount=1
	@echo 'âœ… Rollback complete!'

db-status: ## Show database migration status
	@echo 'ğŸ“Š Database migration status:'
	@$(MVN) liquibase:status

# Docker operations
docker-build: ## Build Docker image
	@echo 'ğŸ³ Building Docker image...'
	@docker build -t aksi/dry-cleaning:latest .
	@echo 'âœ… Docker image built!'

# Clean
clean: ## Clean build artifacts
	@echo 'ğŸ§¹ Cleaning build artifacts...'
	@$(MVN) clean
	@rm -rf target/
	@echo 'âœ… Clean complete!'

# Production build
prod: ## Build for production
	@echo 'ğŸš€ Building for production...'
	@$(MVN) clean package -P production
	@echo 'âœ… Production build complete!'

# Private targets
_show_urls:
	@echo ''
	@echo 'ğŸŒ Service URLs:'
	@echo '   Application:         http://localhost:8080'
	@echo '   API:                 http://localhost:8080/api'
	@echo '   Swagger UI:          http://localhost:8080/swagger-ui.html'
	@echo '   Actuator:            http://localhost:8080/actuator'
	@echo ''
	@echo 'ğŸ› ï¸  Useful commands:'
	@echo '   make logs            # View logs'
	@echo '   make status          # Check status'
	@echo '   make shell           # Open shell'
	@echo '   make down            # Stop all services'
	@echo ''
	@echo 'ğŸ“š API Documentation:'
	@echo '   make bundle-api      # Generate API bundle from all domains'
	@echo '   make generate-docs    # Generate HTML docs from API bundle'
	@echo '   make update-docs      # Update both bundle and HTML docs'
	@echo '   ğŸ“ Bundle: backend/src/main/resources/openapi/aksi-bundled.yaml'
	@echo '   ğŸŒ Docs:   backend/src/main/docs/api/index.html'
	@echo ''
	@echo 'ğŸ”„ Dependency Updates:'
	@echo '   make check-updates   # Show all available updates'
	@echo '   make update-all-safe # Update all (SAFE: minor only)'
	@echo '   make update-dependencies # Update only dependencies'
	@echo '   make update-plugins  # Update only plugins'
	@echo '   make update-properties # Update properties versions'
	@echo '   make revert-updates  # Revert to backup POM'

# Monitoring
monitor: ## Open monitoring dashboards
	@echo 'ğŸ“Š Monitoring URLs:'
	@echo '   Actuator:            http://localhost:8080/actuator'

# Security check
security-check: ## Run security checks
	@echo 'ğŸ”’ Running security checks...'
	@$(MVN) dependency-check:check
	@echo 'âœ… Security check complete!'

# Update dependencies
update-deps: ## Update Maven dependencies
	@echo 'ğŸ“¦ Updating dependencies...'
	@$(MVN) versions:use-latest-versions
	@echo 'âœ… Dependencies updated!'

# Show outdated dependencies
outdated: ## Show outdated dependencies
	@echo 'ğŸ“¦ Checking for outdated dependencies...'
	@echo 'Maven:'
	@$(MVN) versions:display-dependency-updates

# ========================================
# ğŸ”„ DEPENDENCY UPDATE AUTOMATION
# ========================================

check-updates: ## ğŸ” Show all available updates (dependencies, plugins, properties)
	@echo 'ğŸ” Checking all available updates...'
	@echo 'ğŸ“¦ Dependencies:'
	@$(MVN) versions:display-dependency-updates
	@echo ''
	@echo 'ğŸ”Œ Plugins:'
	@$(MVN) versions:display-plugin-updates
	@echo ''
	@echo 'âš™ï¸ Properties:'
	@$(MVN) versions:display-property-updates

update-dependencies: ## ğŸ“¦ Update only dependencies (minor + incremental)
	@echo 'ğŸ“¦ Updating dependencies to latest minor versions...'
	@$(MVN) versions:use-latest-versions -DallowMajorUpdates=false -DallowMinorUpdates=true
	@echo 'âœ… Dependencies updated!'

update-plugins: ## ğŸ”Œ Update Maven plugins
	@echo 'ğŸ”Œ Updating Maven plugins...'
	@$(MVN) versions:use-latest-versions -DallowMajorUpdates=false -DallowMinorUpdates=true -DincludesList=*:*-maven-plugin
	@echo 'âœ… Plugins updated!'

update-properties: ## âš™ï¸ Update properties-based versions
	@echo 'âš™ï¸ Updating properties-based versions...'
	@$(MVN) versions:update-properties -DallowMajorUpdates=false -DallowMinorUpdates=true
	@echo 'âœ… Properties updated!'

update-all-safe: ## ğŸš€ Update everything (SAFE: minor + incremental only)
	@echo 'ğŸš€ Running SAFE update (minor + incremental versions only)...'
	@$(MAKE) update-dependencies
	@$(MAKE) update-plugins
	@$(MAKE) update-properties
	@echo 'âœ… All updates completed safely!'
	@echo 'ğŸ’¡ Run "mvn clean compile" to test the updates'

update-all-major: ## âš ï¸ Update everything including MAJOR versions (DANGEROUS!)
	@echo 'âš ï¸  WARNING: This will update to MAJOR versions!'
	@echo 'âš ï¸  This may introduce breaking changes!'
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo 'ğŸš€ Running MAJOR update...'
	@$(MVN) versions:use-latest-versions -DallowMajorUpdates=true
	@$(MVN) versions:update-properties -DallowMajorUpdates=true
	@echo 'âœ… Major updates completed!'
	@echo 'âš ï¸  Please test thoroughly!'

revert-updates: ## â†©ï¸ Revert to backup POM (if update failed)
	@echo 'â†©ï¸ Reverting to backup pom.xml...'
	@if [ -f pom.xml.versionsBackup ]; then \
		mv pom.xml.versionsBackup pom.xml; \
		echo 'âœ… Reverted to backup!'; \
	else \
		echo 'âŒ No backup found!'; \
	fi

clean-backups: ## ğŸ§¹ Clean version backup files
	@echo 'ğŸ§¹ Cleaning version backup files...'
	@rm -f pom.xml.versionsBackup
	@echo 'âœ… Backup files cleaned!'
